######################################################################
# File: air_quality.yaml                                             #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2023-06-10                                                   #
#                                                                    #                                                                    #
# Copyright (c) 2023 Sen Morgan                                      #
######################################################################

###############################################
## AUTOMATIONS
###############################################
automation:
- id: "Notification_Air_Quality_Bad"
  alias: Notification Air Quality Bad
  trigger:
    - platform: numeric_state
      entity_id: sensor.air_quality_station_iaq
      above: 200
      for: 00:02:00
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "off"
  action:
    - if:
        condition: template
        value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
      then:
        - service: media_player.play_media
          entity_id: media_player.yandex_station
          data:
            # If some of windows are opened, notify to close exact opened window by telling it's name.
            # Otherwise, notify to open window.
            media_content_id: |
              –ó–∞–º–µ—á–µ–Ω–æ –ø–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ –≤ –¥–æ–º–µ,
              {% if states('binary_sensor.windows') == 'off' %}
                —Å–æ–≤–µ—Ç—É—é –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ.
              {% else %}
                —Å–æ–≤–µ—Ç—É—é –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ
                {% if states('binary_sensor.bedroom_window_contact') == 'on' %}
                  –≤ —Å–ø–∞–ª—å–Ω–µ
                {% endif %}
                {% if states('binary_sensor.kitchen_window_contact') == 'on' %}
                  {% if states('binary_sensor.bedroom_window_contact') == 'on' %}
                    {% if states('binary_sensor.living_room_window_contact') == 'on' %}
                      ,
                    {% else %}
                      –∏
                    {% endif %}
                  {% endif %}
                  –Ω–∞ –∫—É—Ö–Ω–µ
                {% endif %}
                {% if states('binary_sensor.living_room_window_contact') == 'on' %}
                  {% if states('binary_sensor.bedroom_window_contact') == 'on' or states('binary_sensor.kitchen_window_contact') == 'on' %}
                    –∏
                  {% endif %}
                  –≤ –≥–æ—Å—Ç–∏–Ω–Ω–æ–π.
                {% endif %}
              {% endif %}

    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üå¨' }} –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞"
        message: >
          –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ –≤ –¥–æ–º–µ —É—Ö—É–¥—à–∏–ª–æ—Å—å –∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {{ states('sensor.air_quality_station_iaq') }}.
    - service: automation.turn_on
      entity_id:
        - automation.notification_air_quality_restored
        - automation.notification_air_quality_open_window_greeting
    - service: automation.turn_off
      entity_id: automation.notification_air_quality_bad

- id: "Notification_Air_Quality_Open_Window_Greeting"
  alias: Notification Air Quality Open Window Greeting
  trigger:
    - platform: state
      entity_id: binary_sensor.windows
      from: "off"
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "off"
  action:
    - if:
        condition: template
        value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
      then:
        - service: media_player.play_media
          entity_id: media_player.yandex_station
          data:
            media_content_id: >
              –ú–æ–ª–æ–¥–µ—Ü! –†–∞–¥–∞, —á—Ç–æ –≤—ã –∑–∞–±–æ—Ç–∏—Ç–µ—Å—å –æ —Å–≤–æ—ë–º –∑–¥–æ—Ä–æ–≤—å–µ.
            media_content_type: text
    - service: automation.turn_off
      entity_id: automation.notification_air_quality_open_window_greeting

- id: "Notification_Air_Quality_Restored"
  alias: Notification Air Quality Restored
  trigger:
    - platform: numeric_state
      entity_id: sensor.air_quality_station_iaq
      below: 50
      for: 00:02:00
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "off"
  action:
    - if:
        condition: template
        value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
      then:
        - service: media_player.play_media
          entity_id: media_player.yandex_station
          data:
            media_content_id: >
              –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ –≤ –¥–æ–º–µ –≤–µ—Ä–Ω—É–ª–æ—Å—å –≤ –Ω–æ—Ä–º—É.
            media_content_type: text
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üå¨' }} –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞"
        message: >
          –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ –≤ –¥–æ–º–µ —É–ª—É—á—à–∏–ª–æ—Å—å –∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {{ states('sensor.air_quality_station_iaq') }}.
    - service: automation.turn_on
      entity_id: automation.notification_air_quality_bad
    - service: automation.turn_off
      entity_id:
        - automation.notification_air_quality_restored
        - automation.notification_air_quality_open_window_greeting
