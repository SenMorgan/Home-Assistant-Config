######################################################################
# File: 3d_printer.yaml                                              #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2023-02-19                                                   #
#                                                                    #
# Info: this file contains automations that are associated to the    #
# 3D printer connected via Octoprint                                 #
#                                                                    #
# Copyright (c) 2023 Sen Morgan                                      #
######################################################################

###############################################
## INPUT BOOLEANS
###############################################
input_boolean:
  3d_printer_and_octo_power:
    name: 3D Printer Power
    icon: mdi:printer-3d

###############################################
## REST COMMANDS
###############################################
rest_command:
  octoprint_shutdown:
    url: !secret OCTOPRINT_SHUTDOWN_URL
    method: POST
    headers:
      X-Api-Key: !secret OCTOPRINT_API_KEY

###############################################
## SCRIPTS
###############################################
script:
  octoprint_shutdown:
    alias: Octoprint Shutdown
    mode: single
    sequence:
      - service: rest_command.octoprint_shutdown

###############################################
## AUTOMATIONS
###############################################
automation:
  ###############################################
  ## Remind me when the print is done
  ###############################################
  - alias: "3D Printer - Print Done"
    id: "3d_printer_print_done"
    trigger:
      platform: state
      entity_id: binary_sensor.octoprint_printing
      from: "on"
      to: "off"
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "3D Printer"
          message: "üéâ –ü–µ—á–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

  ###############################################
  ## Remind me every 10% of the print
  ###############################################
  - alias: "3D Printer - Print Progress"
    id: "3d_printer_print_progress"
    trigger:
      platform: state
      entity_id: sensor.octoprint_job_percentage
    condition:
      condition: template
      value_template: >
        {{ (trigger.to_state.state | int(0)) > 0 and
          ((trigger.to_state.state | int(0)) != (trigger.from_state.state | int(0))) and
           (trigger.to_state.state | int(0)) % 10 == 0 }}
    action:
      - service: notify.mobile_app_sm_s901b
        data_template:
          title: "3D Printer"
          message: "üìà –î–µ—Ç–∞–ª—å –≥–æ—Ç–æ–≤–∞ –Ω–∞ {{ states('sensor.octoprint_job_percentage') | int(0) }}%"

  ###############################################
  ## Remind me when print is paused
  ###############################################
  - alias: "3D Printer - Print Paused"
    id: "3d_printer_print_paused"
    trigger:
      platform: state
      entity_id: sensor.octoprint_current_state
      from: "Printing"
      to:
        - "Paused"
        - "Pausing"
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "‚ö†Ô∏è 3D Printer"
          message: "–ü–µ—á–∞—Ç—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"

  ###############################################
  ## Remind me when print is resumed
  ###############################################
  - alias: "3D Printer - Print Resumed"
    id: "3d_printer_print_resumed"
    trigger:
      platform: state
      entity_id: sensor.octoprint_current_state
      from:
        - "Paused"
        - "Pausing"
      to: "Printing"
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "‚ö†Ô∏è 3D Printer"
          message: "–ü–µ—á–∞—Ç—å –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∞"

  ###############################################
  ## Remind me when bed or hotend is overheated
  ###############################################
  - alias: "3D Printer - Overheated"
    id: "3d_printer_overheated"
    trigger:
      platform: state
      entity_id:
        - sensor.octoprint_actual_bed_temp
        - sensor.octoprint_actual_tool0_temp
    condition:
      condition: or
      conditions:
        - condition: template
          value_template: >
            {{ states('sensor.octoprint_actual_bed_temp') | int(0) > 100 }}
        - condition: template
          value_template: >
            {{ states('sensor.octoprint_actual_tool0_temp') | int(0) > 250 }}
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "üå°Ô∏è 3D Printer –ø–µ—Ä–µ–≥—Ä–µ–ª—Å—è!"
          message: |
            üõèÔ∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å—Ç–æ–ª–∞: {{ states('sensor.octoprint_actual_bed_temp') }}¬∞C
            üî• –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ö–æ—Ç–µ–Ω–¥–∞: {{ states('sensor.octoprint_actual_tool0_temp') }}¬∞C

  ###############################################
  ## Power control
  ###############################################
  - alias: 3D Printer - Power On
    id: 3d_printer_power_on
    mode: restart
    trigger:
      - platform: state
        entity_id: input_boolean.3d_printer_and_octo_power
        from: "off"
        to: "on"
    # Check if new state was not set by ¬´3d_printer_sync_power_state¬ª to awoid infinite loop
    condition:
      - condition: state
        entity_id: switch.3d_printer_socket
        state: "off"
    action:
      - service: switch.turn_on
        entity_id: switch.3d_printer_socket

  - alias: 3D Printer - Power Sync
    id: 3d_printer_power_sync
    mode: single
    trigger:
      - platform: state
        entity_id: switch.3d_printer_socket
    condition:
      - condition: template
        value_template: >
          {{ states('switch.3d_printer_socket') != states('input_boolean.3d_printer_and_octo_power') }}
        # Check if 3d_printer_power_off automation is not running
      - condition: template
        value_template: >
          {{ is_state_attr('automation.3d_printer_power_off', 'current', 0) }}
    action:
      - if:
          - condition: state
            entity_id: switch.3d_printer_socket
            state: "on"
        then:
          - service: input_boolean.turn_on
            entity_id: input_boolean.3d_printer_and_octo_power
        else:
          - service: input_boolean.turn_off
            entity_id: input_boolean.3d_printer_and_octo_power

  - alias: 3D Printer - Power Off
    id: 3d_printer_power_off
    mode: restart
    trigger:
      - platform: state
        entity_id: input_boolean.3d_printer_and_octo_power
        from: "on"
        to: "off"
    # Check if new state was not set by ¬´3d_printer_sync_power_state¬ª to awoid infinite loop
    condition:
      - condition: state
        entity_id: switch.3d_printer_socket
        state: "on"
    action:
      - service: script.turn_on
        entity_id: script.octoprint_shutdown
      # If server is not in state "operational" ‚Äî send me notification and stop powering off
      - if:
          - condition: template
            value_template: "{{ states('sensor.octoprint_current_state') != 'Operational' }}"
        then:
          - service: input_boolean.turn_on
            entity_id: input_boolean.3d_printer_and_octo_power
          - service: notify.mobile_app_sm_s901b
            data:
              title: "‚ö†Ô∏è 3D Printer"
              message: |
                –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å Octoprint —Å–µ—Ä–≤–µ—Ä –≤ —Å–æ—Å—Ç–æ–Ω–∏–∏ ¬´{{ states('sensor.octoprint_current_state') }}¬ª.
                –ü–∏—Ç–∞–Ω–∏—è –ù–ï –æ—Ç–∫–ª—é—á–µ–Ω–æ!
        else:
          # Wait until server is down
          - wait_template: "{{ states('sensor.octoprint_current_state') == 'unavailable' }}"
            timeout: "00:03:00"
            # If server is still up ‚Äî send me notification
          - if:
              - condition: template
                value_template: "{{ states('sensor.octoprint_current_state') != 'unavailable' }}"
            then:
              - service: input_boolean.turn_on
                entity_id: input_boolean.3d_printer_and_octo_power
              - service: notify.mobile_app_sm_s901b
                data:
                  title: "‚ö†Ô∏è 3D Printer"
                  message: |
                    –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∫–ª—é—á–∏—Ç—å Octoprint —Å–µ—Ä–≤–µ—Ä.
                    –ü–∏—Ç–∞–Ω–∏—è –ù–ï –æ—Ç–∫–ª—é—á–µ–Ω–æ!
            else:
              # If server is down, turn off power socket
              - service: switch.turn_off
                entity_id: switch.3d_printer_socket
              - service: input_boolean.turn_off
                entity_id: input_boolean.3d_printer_and_octo_power
