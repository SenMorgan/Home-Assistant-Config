######################################################################
# File: thermostat.yaml                                              #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2022-11-30                                                   #
#                                                                    #
# Info: this file contains automations that are associated to the    #
# Climate (Thermostat).                                              #
#                                                                    #
# Copyright (c) 2022 Sen Morgan                                      #
######################################################################

###############################################
## INPUT BOOLEANS
###############################################
input_boolean:
  heating_season:
    name: Heating Season
    icon: mdi:radiator

###############################################
## BINARY SENSORS
###############################################
binary_sensor:
  - platform: template
    sensors:
      thermostat_heating:
        friendly_name: Thermostat is heating
        value_template: >
          {{ is_state_attr('climate.family_room', 'hvac_action', "heating") }}
      freeze_alert_at_night:
        friendly_name: Temperature is below 19°C at night
        value_template: >
          {{ now().hour >= 0 and now().hour < 6 and
            ((state_attr('climate.family_room', 'current_temperature') | float(0) < 19.0) or
             (states('sensor.ble_temperature_atc_bedroom') | float(0) < 19.0) or
             (states('sensor.ble_temperature_atc_living_room') | float(0) < 19.0)) }}

      # ETRVs are requesting heat if «current_temperature» is less than «temperature» on any of ETRVs
      etrvs_requesting_heat:
        friendly_name: ETRVs are requesting heat
        value_template: >
          {{ state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'current_temperature') <
                state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'temperature') or
              state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'current_temperature') <
                state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'temperature') or
              state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'current_temperature') <
                state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'temperature') }}

###############################################
## INPUT BUTTONS
###############################################
input_button:
  thermostat_10_minutes_heating:
    name: Heat 10 Minutes
    icon: mdi:radiator

###############################################
## INPUT DATETIMES
###############################################
input_datetime:
  thermostat_10_minutes_heating_time_end:
    name: Thermostat 10 Minutes Heating Time End
    has_date: true
    has_time: true
  thermostat_windows_close_delay_time_end:
    name: Thermostat Windows Close Delay Time End
    has_date: true
    has_time: true

###############################################
## INPUT NUMBERS
###############################################
input_number:
  thermostat_saved_target_temperature:
    name: Thermostat Saved Target Temperature
    min: 15.0
    max: 30.0
    initial: 20.0
  thermostat_new_target_temperature:
    name: Thermostat New Target Temperature
    min: 15.0
    max: 30.0
    initial: 20.0
  etrv_bedroom_default_temperature:
    name: ETRV Bedroom Default Temperature
    step: 0.5
    min: 18.0
    max: 25.0
    initial: 21.0
  etrv_kitchen_default_temperature:
    name: ETRV Kitchen Default Temperature
    step: 0.5
    min: 18.0
    max: 25.0
    initial: 21.0
  etrv_living_room_default_temperature:
    name: ETRV Living Room Default Temperature
    step: 0.5
    min: 18.0
    max: 25.0
    initial: 21.0
  etrv_min_target_temperature:
    name: ETRV Min Target Temperature
    step: 0.5
    min: 17.0
    max: 21.0
    initial: 19.0
  etrv_max_target_temperature:
    name: ETRV Max Target Temperature
    step: 0.5
    min: 21.0
    max: 25.0
    initial: 23.0

###############################################
## AUTOMATIONS
###############################################
automation:
  ###############################################
  ## Thermostat ECO Mode by Window
  ###############################################
  - alias: Thermostat ECO Mode by Window Enable
    id: thermostat_eco_mode_by_window_enable
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.windows
        id: Some Window Opened
        from: "off"
        to: "on"
        for: "00:00:10"
      - platform: state
        entity_id: binary_sensor.windows
        id: All Windows Closed
        from: "on"
        to: "off"
        for: "00:00:10"
    condition:
      - condition: state
        entity_id: input_boolean.heating_season
        state: "on"
        # If some window was opened and thermostat is in «heat» mode
        # or if all windows were closed and thermostat is in «off» mode
      - condition: template
        value_template: >
          {{ (states('climate.family_room') == 'heat' and is_state('binary_sensor.windows', 'on')) or
              (states('climate.family_room') == 'off' and is_state('binary_sensor.windows', 'off')) }}
    action:
      - if:
          - condition: state
            entity_id: binary_sensor.windows
            state: "on"
        # If some window was opened
        then:
          # If «10 minutes heating» automation is enabled now - disable it
          - if:
              - condition: state
                entity_id: automation.thermostat_10_minutes_heating_disable
                state: "on"
            then:
              - if:
                  condition: template
                  value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
                then:
                  - service: media_player.play_media
                    entity_id: media_player.yandex_station
                    data:
                      media_content_id: Подогрев квартиры окончен раньше, потому что было открыто окно
                      media_content_type: text
              # Disable «10 minutes heating» automation
              - service: automation.turn_off
                entity_id: automation.thermostat_10_minutes_heating_disable

          # Set thermostat mode to «off»
          - service: climate.set_hvac_mode
            entity_id: climate.family_room
            data:
              hvac_mode: "off"

        # If all windows were closed
        else:
          # Wait 30 minutes before restoring thermostat mode
          - service: input_datetime.set_datetime
            data:
              entity_id: input_datetime.thermostat_windows_close_delay_time_end
              datetime: "{{ now() + timedelta(minutes=30) }}"
          - service: automation.turn_on
            entity_id:
              - automation.thermostat_eco_mode_by_window_reset
              - automation.thermostat_eco_mode_by_window_disable

  - alias: Thermostat ECO Mode by Window Reset
    id: thermostat_eco_mode_by_window_reset
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.windows
        from: "off"
        to: "on"
        for: "00:00:05"
    action:
      - service: automation.turn_off
        entity_id:
          - automation.thermostat_eco_mode_by_window_disable
          - automation.thermostat_eco_mode_by_window_reset

  - alias: Thermostat ECO Mode by Window Disable
    id: thermostat_eco_mode_by_window_disable
    mode: single
    trigger:
      # Trigger every 1 minute
      - platform: time_pattern
        minutes: "/1"
    condition:
      # We use here template condition because time condition ignores date part of timestamp
      - condition: template
        value_template: "{{ as_timestamp(now()) > as_timestamp(states('input_datetime.thermostat_windows_close_delay_time_end'), 0) }}"
    action:
      # Set thermostat mode to «heat»
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "heat"
      - service: automation.turn_off
        entity_id:
          - automation.thermostat_eco_mode_by_window_reset
          - automation.thermostat_eco_mode_by_window_disable

  ###############################################
  ## Thermostat Emergency Control
  ###############################################

  - alias: Thermostat Freeze Alert at Night
    id: thermostat_freeze_alert_at_night_at_night
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.freeze_alert_at_night
        to: "on"
        for: "00:05:00"
      - platform: time_pattern
        hours: "/1"
    condition:
      - condition: state
        entity_id: input_boolean.heating_season
        state: "on"
      - condition: state
        entity_id: binary_sensor.freeze_alert_at_night
        state: "on"
      - condition: state
        entity_id: binary_sensor.people_home
        state: "on"
      # If thermostat is in «heat» mode and temperature is below 19°C or if thermostat is in «off» mode
      - condition: template
        value_template: >
          {{ (states('climate.family_room') == 'heat' and
              state_attr('climate.family_room', 'temperature') <= 19.0) or
              states('climate.family_room') == 'off' }}
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: Термостат был снова включен в {{ states('sensor.time') }}, чтобы вы не замёрзли
      # Set thermostat mode to «heat»
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "heat"
      # Wait till thermostat will be ready to accept new target temperature
      - wait_template: "{{ state_attr('climate.family_room', 'temperature') != None }}"
        timeout: "00:30:00"
      # Set temperature to 20°C
      - service: climate.set_temperature
        entity_id: climate.family_room
        data:
          temperature: 20

  - alias: Thermostat Preheat Alert
    id: thermostat_preheat_alert
    mode: restart
    trigger:
      - platform: numeric_state
        entity_id: climate.family_room
        attribute: current_temperature
        above: 24.0
        for: "00:05:00"
      - platform: time_pattern
        hours: "/1"
    condition:
      - condition: state
        entity_id: input_boolean.heating_season
        state: "on"
      - condition: numeric_state
        entity_id: climate.family_room
        attribute: current_temperature
        above: 24.0
      # If thermostat is in «heat» mode and temperature is above 24°C
      - condition: template
        value_template: >
          {{ states('climate.family_room') == 'heat' and
              state_attr('climate.family_room', 'temperature') >= 25.0 }}
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "{{ '🚨' }} Превышение температуры!"
          message: >
            Термостат был переведён в автоматический режим по причине высокой температуры в квартире в {{ states('sensor.time') }}
      # Set thermostat mode to «heat»
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "heat"
      # Wait till thermostat will be ready to accept new target temperature
      - wait_template: "{{ state_attr('climate.family_room', 'temperature') != None }}"
        timeout: "00:30:00"
      # Set temperature to 20°C
      - service: climate.set_temperature
        entity_id: climate.family_room
        data:
          temperature: 20

  ###############################################
  ## Thermostat 10 Minutes Heating
  ###############################################

  - alias: Thermostat 10 Minutes Heating Enable
    id: thermostat_10_minutes_heating_enable
    mode: single
    trigger:
      - platform: state
        entity_id: input_button.thermostat_10_minutes_heating
    action:
      - if:
          - condition: state
            entity_id: automation.thermostat_10_minutes_heating_disable
            state: "on"
        then:
          - if:
              condition: template
              value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
            then:
              - service: media_player.play_media
                entity_id: media_player.yandex_station
                data:
                  media_content_id: Подогрев квартиры уже включен
                  media_content_type: text
        else:
          # If «ECO mode by windows» automation is enabled now - disable it
          - if:
              - condition: state
                entity_id: automation.thermostat_eco_mode_by_window_disable
                state: "on"
            then:
              - service: automation.turn_off
                entity_id:
                  - automation.thermostat_eco_mode_by_window_reset
                  - automation.thermostat_eco_mode_by_window_disable
          - if:
              condition: template
              value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
            then:
              - service: media_player.play_media
                entity_id: media_player.yandex_station
                data:
                  media_content_id: Включен подогрев квартиры на 10 минут
                  media_content_type: text
          # Set thermostat mode to «heat» and wait until 'temperature' attribute will become not "None"
          - service: climate.set_hvac_mode
            entity_id: climate.family_room
            data:
              hvac_mode: "heat"
          # Wait till thermostat will be ready to accept new target temperature
          - wait_template: "{{ state_attr('climate.family_room', 'temperature') != None }}"
            timeout: "00:30:00"
          # Save actual thermostat target temperature
          # - service: input_number.set_value
          #   data:
          #     entity_id: input_number.thermostat_saved_target_temperature
          #     value: "{{ state_attr('climate.family_room', 'temperature') | float(21) }}"
          # Set new thermostat target temperature by adding 1°C to the current temperature
          - service: input_number.set_value
            data:
              entity_id: input_number.thermostat_new_target_temperature
              value: "{{ (state_attr('climate.family_room', 'current_temperature') | float(23)) + 1  }}"
          - service: script.turn_on
            entity_id: script.tell_what_windows_are_opened
          # Increase thermostat temperature by 1°C from current temperature
          - service: climate.set_temperature
            entity_id: climate.family_room
            data:
              temperature: "{{ states('input_number.thermostat_new_target_temperature') }}"
          # Set heating_time_end to a time ten minutes in the future
          - service: input_datetime.set_datetime
            data:
              entity_id: input_datetime.thermostat_10_minutes_heating_time_end
              datetime: "{{ now() + timedelta(minutes=10) }}"
          # Wait here until actual target temperature is the same as new target temperature
          - wait_template: |
              {{ state_attr('climate.family_room', 'temperature') ==
              (states('input_number.thermostat_new_target_temperature') | float(0)) }}
            timeout: "00:01:00"
            continue_on_timeout: false
          - service: automation.turn_on
            entity_id: automation.thermostat_10_minutes_heating_disable

  - alias: Thermostat 10 Minutes Heating Disable
    id: thermostat_10_minutes_heating_disable
    mode: single
    trigger:
      # Trigger every 30 seconds
      - platform: time_pattern
        seconds: "/30"
      # Or if thermostat changed it's mode
      - platform: state
        entity_id: climate.family_room
    condition:
      # Either time condition or thermostat mode condition
      - condition: or
        conditions:
          # We use here template condition because time condition ignores date part of timestamp
          - condition: template
            value_template: "{{ as_timestamp(now()) > as_timestamp(states('input_datetime.thermostat_10_minutes_heating_time_end'), 0) }}"
          - condition: template
            value_template: "{{ not is_state('climate.family_room', 'heat') }}"
            # Compare new target temperature with actual target temperature to know if the temperature was manually changed
          - condition: template
            value_template: |
              {{ state_attr('climate.family_room', 'temperature') !=
              (states('input_number.thermostat_new_target_temperature') | float(0)) }}
    action:
      - if:
          condition: template
          value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
        then:
          - service: media_player.play_media
            entity_id: media_player.yandex_station
            data:
              media_content_id: Подогрев квартиры окончен
              media_content_type: text
      # Restore saved thermostat target temperature
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "heat"
      # Wait till thermostat will be ready to accept new target temperature
      - wait_template: "{{ state_attr('climate.family_room', 'temperature') != None }}"
        timeout: "00:30:00"
      - service: climate.set_temperature
        entity_id: climate.family_room
        data:
          temperature: "{{ states('input_number.thermostat_saved_target_temperature') | float(21) }}"
      - service: automation.turn_off
        entity_id: automation.thermostat_10_minutes_heating_disable

  ###############################################
  ## Thermostat ECO Mode When Noone Home
  ###############################################

  - alias: Thermostat ECO Mode When Noone Home Enable
    id: thermostat_eco_mode_when_noone_home_enable
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.people_home
        to: "off"
        for: "00:05:00"
    condition:
      - condition: state
        entity_id: input_boolean.heating_season
        state: "on"
      - condition: template
        value_template: "{{ not is_state('climate.family_room', 'off') }}"
    action:
      # Set thermostat mode to «off»
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "off"
      - service: automation.turn_on
        entity_id: automation.thermostat_eco_mode_when_noone_home_disable
      # Stop all automations that can change thermostat mode
      - service: automation.turn_off
        entity_id:
          - automation.thermostat_eco_mode_by_window_reset
          - automation.thermostat_eco_mode_by_window_disable
          - automation.thermostat_10_minutes_heating_disable

  - alias: Thermostat ECO Mode When Noone Home Disable
    id: thermostat_eco_mode_when_noone_home_disable
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.people_home
        to: "on"
    condition:
      - condition: template
        value_template: "{{ is_state('climate.family_room', 'off') }}"
    action:
      - service: notify.mobile_app_sm_s901b
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: |
            Термостат переведён в нормальный режим.
            Температура дома: {{ state_attr('climate.family_room', 'current_temperature') }}°C
      # If some window is opened, set thermostat mode to «off» mode
      - if:
          - condition: state
            entity_id: binary_sensor.windows
            state: "on"
        then:
          - service: climate.set_hvac_mode
            entity_id: climate.family_room
            data:
              hvac_mode: "off"
        # If no windows are opened, set thermostat mode to «heat» mode
        else:
          - service: climate.set_hvac_mode
            entity_id: climate.family_room
            data:
              hvac_mode: "heat"
      # Disable this automation
      - service: automation.turn_off
        entity_id: automation.thermostat_eco_mode_when_noone_home_disable

  # If one of ETRV is in "heat" state and climate.family_room is not in "heat" state,
  # and all windows are closed - save current temperature to input_number.thermostat_saved_target_temperature
  # and set new thermostat target temperature by adding 2°C to the current temperature to force enable heating.
  - alias: Thermostat ETRV Heating Enable
    id: thermostat_etrv_heating_enable
    mode: single
    trigger:
      # Trigger with every climate.danfoss_* entity state change
      - platform: state
        entity_id:
          - climate.danfoss_etrv0100_bedroom_thermostat
          - climate.danfoss_etrv0103_kitchen_thermostat
          - climate.danfoss_etrv0103_living_room_thermostat
    condition:
      - condition: state
        entity_id: input_boolean.heating_season
        state: "on"
      # If all ETRVs are requesting heat
      - condition: state
        entity_id: binary_sensor.etrvs_requesting_heat
        state: "on"
      - condition: state
        entity_id: binary_sensor.people_home
        state: "on"
      # If all windows are closed
      - condition: state
        entity_id: binary_sensor.windows
        state: "off"
      # If not already heating
      - condition: state
        entity_id: binary_sensor.thermostat_heating
        state: "off"
    action:
      # Set thermostat mode to «heat» and wait until 'temperature' attribute will become not "None"
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "heat"
      # Wait till thermostat will be ready to accept new target temperature
      - wait_template: "{{ state_attr('climate.family_room', 'temperature') != None }}"
        timeout: "00:30:00"
      # Save actual thermostat target temperature
      # - service: input_number.set_value
      #   data:
      #     entity_id: input_number.thermostat_saved_target_temperature
      #     value: "{{ state_attr('climate.family_room', 'temperature') | float(21) }}"
      # Set new thermostat target temperature by adding 2°C to the current temperature
      - service: input_number.set_value
        data:
          entity_id: input_number.thermostat_new_target_temperature
          value: "{{ (state_attr('climate.family_room', 'current_temperature') | float(24)) + 2 }}"
      # Send new target temperature to thermostat
      - service: climate.set_temperature
        entity_id: climate.family_room
        data:
          temperature: "{{ states('input_number.thermostat_new_target_temperature') }}"
      # Wait here until actual target temperature is the same as new target temperature
      - wait_template: |
          {{ state_attr('climate.family_room', 'temperature') ==
          (states('input_number.thermostat_new_target_temperature') | float(0)) }}
        timeout: "00:01:00"
        continue_on_timeout: false
      - service: automation.turn_on
        entity_id: automation.thermostat_etrv_heating_disable
      - variables:
          message: >-
            {% set rooms = [] %}
            {% if state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'current_temperature') <
                    state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'temperature') %}
              {% set rooms = rooms + ['спальня'] %}
            {% endif %}
            {% if state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'current_temperature') <
                    state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'temperature') %}
              {% set rooms = rooms + ['кухня'] %}
            {% endif %}
            {% if state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'current_temperature') <
                    state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'temperature') %}
              {% set rooms = rooms + ['гостиная'] %}
            {% endif %}
            Отопление было включено в {{ states('sensor.time') }} в комнат{{ 'ах' if rooms | length > 1 else 'е' }}:
            {{ rooms[:-1] | join(', ') }}{% if rooms | length > 1 %} и {% endif %}{{ rooms[-1] if rooms | length > 0 else '' }}
    #   - service: persistent_notification.create
    #     data:
    #       title: "{{ 'ℹ️' }} Системное уведомление"
    #       message: "{{ message }}"
    #   - service: notify.mobile_app_sm_s901b
    #     data:
    #       title: "{{ 'ℹ️' }} Системное уведомление"
    #       message: "{{ message }}"
      - service: automation.turn_on
        entity_id: automation.thermostat_etrv_heating_disable

  # If all ETRVs are not in "heat" state - restore mate.family_room target temperature.
  - alias: Thermostat ETRV Heating Disable
    id: thermostat_etrv_heating_disable
    mode: single
    trigger:
      # Trigger if all ETRVs are not requesting heat
      - platform: state
        entity_id: binary_sensor.etrvs_requesting_heat
        to: "off"
      # Trigger every 1 minute
      - platform: time_pattern
        minutes: "/1"
    condition:
      # If thermostat is in "heat" mode
      - condition: state
        entity_id: climate.family_room
        state: "heat"
      # If all ETRVs are not requesting heat
      - condition: state
        entity_id: binary_sensor.etrvs_requesting_heat
        state: "off"
    action:
      - variables:
          timestamp: "{{ states('sensor.time') }}"
      # Restore saved thermostat target temperature
      - service: climate.set_hvac_mode
        entity_id: climate.family_room
        data:
          hvac_mode: "heat"
      # Wait till thermostat will be ready to accept new target temperature
      - wait_template: "{{ state_attr('climate.family_room', 'temperature') != None }}"
        timeout: "00:30:00"
      - service: climate.set_temperature
        entity_id: climate.family_room
        data:
          temperature: "{{ states('input_number.thermostat_saved_target_temperature') | float(21) }}"
    #   - service: persistent_notification.create
    #     data:
    #       title: "{{ 'ℹ️' }} Системное уведомление"
    #       message: Отопление было выключено в {{ timestamp }}
    #   - service: notify.mobile_app_sm_s901b
    #     data:
    #       title: "{{ 'ℹ️' }} Системное уведомление"
    #       message: Отопление было выключено в {{ timestamp }}
      - service: automation.turn_off
        entity_id: automation.thermostat_etrv_heating_disable

  # ETRVs do not have child lock themselves so we need to check if taget tempature
  # is in range of min and max target temperature and if not - set it to 21°C
  # Kitchen
  - alias: Thermostat ETRV Temp Out of Range Kitchen
    id: thermostat_etrv_temp_out_of_range_kitchen
    mode: single
    trigger:
      - platform: state
        entity_id: climate.danfoss_etrv0103_kitchen_thermostat
    condition:
      - condition: template
        value_template: |
          {{ (state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'temperature') <
          (states('input_number.etrv_min_target_temperature')) | float(17)) or
          (state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'temperature') >
          (states('input_number.etrv_max_target_temperature')) | float(25)) }}
    action:
      - variables:
          timestamp: "{{ states('sensor.time') }}"
          target_temperature: "{{ state_attr('climate.danfoss_etrv0103_kitchen_thermostat', 'temperature') }}"
          set_temperature: "{{ states('input_number.etrv_kitchen_default_temperature') | float(21) }}"
          message: >-
            Температура на кухне вышла за допустимые пределы в {{ timestamp }}.
            Возвращаю температуру с {{ target_temperature }}°C на {{ set_temperature }}°C
      - service: climate.set_temperature
        entity_id: climate.danfoss_etrv0103_kitchen_thermostat
        data:
          temperature: "{{ set_temperature }}"
      - service: persistent_notification.create
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: "{{ message }}"
      - service: notify.mobile_app_sm_s901b
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: "{{ message }}"

  # Bedroom
  - alias: Thermostat ETRV Temp Out of Range Bedroom
    id: thermostat_etrv_temp_out_of_range_bedroom
    mode: single
    trigger:
      - platform: state
        entity_id: climate.danfoss_etrv0100_bedroom_thermostat
    condition:
      - condition: template
        value_template: |
          {{ (state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'temperature') <
          (states('input_number.etrv_min_target_temperature')) | float(17)) or
          (state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'temperature') >
          (states('input_number.etrv_max_target_temperature')) | float(25)) }}
    action:
      - variables:
          timestamp: "{{ states('sensor.time') }}"
          target_temperature: "{{ state_attr('climate.danfoss_etrv0100_bedroom_thermostat', 'temperature') }}"
          set_temperature: "{{ states('input_number.etrv_bedroom_default_temperature') | float(21) }}"
          message: >-
            Температура в спальне вышла за допустимые пределы в {{ timestamp }}.
            Возвращаю температуру с {{ target_temperature }}°C на {{ set_temperature }}°C
      - service: climate.set_temperature
        entity_id: climate.danfoss_etrv0100_bedroom_thermostat
        data:
          temperature: "{{ set_temperature }}"
      - service: persistent_notification.create
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: "{{ message }}"
      - service: notify.mobile_app_sm_s901b
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: "{{ message }}"

  # Living Room
  - alias: Thermostat ETRV Temp Out of Range Living Room
    id: thermostat_etrv_temp_out_of_range_living_room
    mode: single
    trigger:
      - platform: state
        entity_id: climate.danfoss_etrv0103_living_room_thermostat
    condition:
      - condition: template
        value_template: |
          {{ (state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'temperature') <
          (states('input_number.etrv_min_target_temperature')) | float(17)) or
          (state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'temperature') >
          (states('input_number.etrv_max_target_temperature')) | float(25)) }}
    action:
      - variables:
          timestamp: "{{ states('sensor.time') }}"
          target_temperature: "{{ state_attr('climate.danfoss_etrv0103_living_room_thermostat', 'temperature') }}"
          set_temperature: "{{ states('input_number.etrv_living_room_default_temperature') | float(21) }}"
          message: >-
            Температура в гостиной вышла за допустимые пределы в {{ timestamp }}.
            Возвращаю температуру с {{ target_temperature }}°C на {{ set_temperature }}°C
      - service: climate.set_temperature
        entity_id: climate.danfoss_etrv0103_living_room_thermostat
        data:
          temperature: "{{ set_temperature }}"
      - service: persistent_notification.create
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: "{{ message }}"
      - service: notify.mobile_app_sm_s901b
        data:
          title: "{{ 'ℹ️' }} Системное уведомление"
          message: "{{ message }}"

