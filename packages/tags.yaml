######################################################################
# File: tags.yaml                                                  #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2024-02-08                                                   #
#                                                                    #                                                                    #
# Copyright (c) 2024 Sen Morgan                                      #
######################################################################

###############################################
## AUTOMATIONS
###############################################
automation:
  - alias: Tag Near PC was scanned
    id: tag_near_pc_was_scanned
    mode: single
    triggers:
      - trigger: tag
        tag_id: c45d3b71-2ade-45e3-8663-f0028f52b01d
    actions:
      - action: input_boolean.toggle
        target:
          entity_id: input_boolean.show_cameras_in_lovelace
      - action: notify.mobile_app_sm_s901b
        data:
          title: "üëÅÔ∏è –†–µ–∂–∏–º –∫–∞–º–µ—Ä"
          message: >-
            {% if is_state('input_boolean.show_cameras_in_lovelace', 'on') %}
              –ö–∞–º–µ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã
            {% else %}
              –ö–∞–º–µ—Ä—ã –≤—ã–∫–ª—é—á–µ–Ω—ã
            {% endif %}

  - alias: Reenable Cameras if Hided
    id: reenable_cameras_if_hided
    mode: single
    triggers:
      - trigger: state
        entity_id: input_boolean.show_cameras_in_lovelace
        to: "off"
        for: "01:00:00"
    actions:
      - action: input_boolean.turn_on
        target:
          entity_id: input_boolean.show_cameras_in_lovelace
      - action: notify.mobile_app_sm_s901b
        data:
          title: "üëÅÔ∏è –†–µ–∂–∏–º –∫–∞–º–µ—Ä"
          message: "–ö–∞–º–µ—Ä—ã –≤–∫–ª—é—á–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ {{ states('sensor.time') }}"

  - alias: Tag Near Entrance was scanned
    id: tag_near_entrance_was_scanned
    mode: restart
    triggers:
      - trigger: tag
        tag_id: 5954e702-f87d-4955-969c-5231af33ece8
    actions:
      - action: input_boolean.turn_on
        entity_id: input_boolean.guest_mode
      # Turn off the script that could be running at this moment
      - action: script.turn_off
        entity_id: script.turn_off_lights_after_people_leave
      - variables:
          message: –í–∫–ª—é—á–µ–Ω –≥–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º - —Ç–µ—Ä–º–æ—Å—Ç–∞—Ç –∏ —Å–≤–µ—Ç –Ω–µ –±—É–¥—É—Ç –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ—Å–ª–µ —É—Ö–æ–¥–∞.
          # Including an id in the action allows us to identify this script run
          # and not accidentally trigger for other notification actions
          action_disable: "{{ 'action_disable' ~ context.id }}"
      - action: media_player.play_media
        entity_id: media_player.yandex_station_midi
        data:
          media_content_id: "{{ message }}"
          media_content_type: text
      - action: notify.mobile_app_sm_s901b
        data:
          title: "üë§ –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º"
          message: "{{ message }}"
          data:
            actions:
              - action: "{{ action_disable }}"
                title: ‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ
                icon: mdi:account-off
      - wait_for_trigger:
          - trigger: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_disable }}"
      - if:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == action_disable }}"
        then:
          - action: input_boolean.turn_off
            target:
              entity_id: input_boolean.guest_mode
          - action: notify.mobile_app_sm_s901b
            data:
              title: "üë§ –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º"
              message: –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω

  - alias: Ignore People Presence reset
    id: guest_mode_reset
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.people_home
        to: "on"
        for: "00:15:00"
    conditions:
      - condition: state
        entity_id: input_boolean.guest_mode
        state: "on"
    actions:
      - action: input_boolean.turn_off
        target:
          entity_id: input_boolean.guest_mode
      - variables:
          # Including an id in the action allows us to identify this script run
          # and not accidentally trigger for other notification actions
          action_enable_back_on: "{{ 'action_enable_back_on' ~ context.id }}"
      - action: notify.mobile_app_sm_s901b
        data:
          title: "üë§ –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º"
          message: "–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ {{ states('sensor.time') }}. –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ?"
          data:
            actions:
              - action: "{{ action_enable_back_on }}"
                title: ‚Üª –í–∫–ª—é—á–∏—Ç—å —Å–Ω–æ–≤–∞
                icon: mdi:account-check
      - wait_for_trigger:
          - trigger: event
            event_type: mobile_app_notification_action
            event_data:
              action: "{{ action_enable_back_on }}"
      - if:
          - condition: template
            value_template: "{{ wait.trigger.event.data.action == action_enable_back_on }}"
        then:
          - action: input_boolean.turn_on
            target:
              entity_id: input_boolean.guest_mode
          - action: notify.mobile_app_sm_s901b
            data:
              title: "üë§ –ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º"
              message: "–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω —Å–Ω–æ–≤–∞ –≤ {{ states('sensor.time') }}"
