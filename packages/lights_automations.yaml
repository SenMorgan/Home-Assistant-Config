######################################################################
# File: lights_automations.yaml                                      #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2024-02-13                                                   #
#                                                                    #
# Copyright (c) 2024 Sen Morgan                                      #
######################################################################

###############################################
## SETTINGS AND VARIABLES
###############################################
homeassistant:
  customize:
    package.node_anchors:
      sys_notify_title_info: &sys_notify_title_info "üí¨ –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
      sys_notify_title_warning: &sys_notify_title_warning "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"
      sys_notify_title_critical: &sys_notify_title_critical "üö® –í–Ω–∏–º–∞–Ω–∏–µ!"

###############################################
## INPUT BUTTONS
###############################################
input_button:
  parking_light:
    name: Parking Light
    icon: mdi:light-flood-down
  activate_night_mode:
    name: Activate Night Mode
    icon: mdi:moon-waning-crescent

###############################################
## SCRIPTS
###############################################
script:
  turn_off_all_lights:
    alias: Turn Off All Lights
    sequence:
      - action: light.turn_off
        entity_id: all
      - action: switch.turn_off
        entity_id:
          - switch.monolith_speakers
          - switch.interactive_cz_map_enable
          - switch.ex_commandstation_tracks_power

  switch_on_parking_light:
    alias: Switch On Parking Light
    sequence:
      - action: switch.turn_off
        target:
          entity_id: switch.parking_light
      - delay:
          seconds: 15
      - repeat:
          while:
            - condition: state
              entity_id: switch.parking_light
              state: "off"
            # Don't do it too many times
            - condition: template
              value_template: "{{ repeat.index <= 300 }}"
          sequence:
            - action: switch.turn_on
              target:
                entity_id: switch.parking_light
            - delay:
                seconds: 1

  activate_night_mode:
    alias: Activate Night Mode
    sequence:
      - action: scene.turn_on
        entity_id: scene.good_night
      - action: input_boolean.turn_on
        entity_id:
          - input_boolean.home_night_mode
          - input_boolean.silent_mode
      - action: script.turn_off_all_lights
      - action: script.notify_if_some_window_is_opened_during_heating_season

###############################################
## AUTOMATIONS
###############################################
automation:
  - id: "welcome_lights"
    alias: Welcome Lights
    mode: restart
    triggers:
      - trigger: state
        entity_id: person.sen
        to: "home"
      - trigger: state
        entity_id: person.kris
        to: "home"
    actions:
      # Wait until hall door is opened
      - wait_template: "{{ states('binary_sensor.hall_door_contact') == 'on' }}"
        timeout: 00:15:00
        continue_on_timeout: false
      # If it is daytime - turn on welcome scene
      - if:
          - condition: time
            after: "05:00:00"
            before: "22:00:00"
          - condition: state
            entity_id: input_boolean.home_night_mode
            state: "off"
        then:
          - action: scene.turn_on
            entity_id: scene.welcome_home
          # If Sen came home - turn on his welcome scene too
          - if:
              - condition: state
                entity_id: person.sen
                state: "home"
            then:
              - action: scene.turn_on
                entity_id: scene.welcome_home_sen
        else:
          # If it is nighttime - just turn on hall edison bulb on half brightness
          - action: light.turn_on
            entity_id: light.hall_edison_bulb
            data:
              brightness_pct: 50

  - id: "home_all_lights_off"
    alias: Home All Lights OFF
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.hall_door_contact
        from: "on"
        to: "off"
    conditions:
      - condition: state
        entity_id: binary_sensor.people_home
        state: "on"
      - condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
    actions:
      - wait_template: "{{ states('binary_sensor.people_home') == 'off' }}"
        timeout: "00:30:00"
        continue_on_timeout: false
      # Wait 2 minutes and check if binary_sensor.people_home is still off to prevent accidental triggers
      - delay: 00:02:00
      - if:
          - condition: state
            entity_id: binary_sensor.people_home
            state: "off"
        then:
          # Check if guest mode is still disabled after waiting
          - if:
              - condition: state
                entity_id: input_boolean.guest_mode
                state: "off"
            then:
              - action: script.turn_on
                entity_id: script.turn_off_all_lights
              - action: scene.turn_on
                entity_id: scene.no_people_home
              - variables:
                  # Including an id in the action allows us to identify this script run
                  # and not accidentally trigger for other notification actions
                  action_enable_guest_mode: "{{ 'action_enable_guest_mode' ~ context.id }}"
              - action: notify.mobile_app_sen_s25
                data:
                  title: "üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è"
                  message: >
                    {% if is_state('input_boolean.heating_season', 'on') %}
                      –¢–µ—Ä–º–æ—Å—Ç–∞—Ç –∏ —Å–≤–µ—Ç –±—ã–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
                    {% else %}
                      –í–µ—Å—å —Å–≤–µ—Ç –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω
                    {% endif %}
                  data:
                    actions:
                      - action: "{{ action_enable_guest_mode }}"
                        title: üë§ –í–∫–ª—é—á–∏—Ç—å –≥–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º
              - wait_for_trigger:
                  - trigger: event
                    event_type: mobile_app_notification_action
                    event_data:
                      action: "{{ action_enable_guest_mode }}"
              - if:
                  - condition: template
                    value_template: "{{ wait.trigger.event.data.action == action_enable_guest_mode }}"
                then:
                  - action: script.enable_guest_mode

  - id: "hall_edison_bulb_by_motion_off"
    alias: Hall Edison Bulb by Motion OFF
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.aqara_hall_motion_sensor_motion
        to: "off"
        for: 00:02:00
    actions:
      # If hall lights are off - turn off edison bulb immediately
      - if:
          - condition: state
            entity_id: light.hall_lights
            state: "off"
        then:
          - action: light.turn_off
            entity_id: light.hall_edison_bulb
        else:
          # Otherwise, wait until they are turned off with a timeout
          - wait_template: "{{ states('light.hall_lights') == 'off' }}"
            timeout: 01:00:00
            continue_on_timeout: false
          - action: light.turn_off
            entity_id: light.hall_edison_bulb

  ###############################################
  ## Other Lights Automations
  ###############################################
  - id: "kitchen_asus_pc_background_lights_on"
    alias: Kitchen Asus PC Background Lights ON
    triggers:
      - trigger: state
        entity_id: switch.asus_pc
        from: "off"
        to: "on"
    conditions:
      # Only if Sen is home
      - condition: state
        entity_id: person.sen
        state: "home"
    actions:
      - action: light.turn_on
        entity_id: light.gyver_lamp
        data:
          effect: "O–≥o–Ω—å"
          brightness: 150
          rgb_color: [255, 39, 25]

  - id: "kitchen_asus_pc_background_lights_off"
    alias: Kitchen Asus PC Background Lights OFF
    triggers:
      - trigger: state
        entity_id: switch.asus_pc
        from: "on"
        to: "off"
    actions:
      - action: light.turn_off
        entity_id: light.gyver_lamp

  - id: "kitchen_clock_disable_by_presence"
    alias: Kitchen Clock Disable by Presence
    triggers:
      - trigger: state
        entity_id: binary_sensor.people_home
        to: "off"
        for: 00:01:00
    condition:
      - condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
    actions:
      - action: light.turn_off
        entity_id: light.7_seg_clock

  - id: "kitchen_clock_reenable"
    alias: Kitchen Clock Reenable
    mode: restart
    triggers: &any_kitchen_activity_trigger
      - trigger: state
        entity_id: binary_sensor.kitchen_motion_alarm
        to: "on"
      - trigger: state
        entity_id: switch.asus_pc
        to: "on"
      - trigger: state
        entity_id: input_boolean.silent_mode
        to: "off"
      - trigger: state
        entity_id: input_boolean.home_night_mode
        to: "off"
    conditions:
      - condition: state
        entity_id: light.7_seg_clock
        state: "off"
      - condition: state
        entity_id: binary_sensor.people_home
        state: "on"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: light.turn_on
        entity_id: light.7_seg_clock

  - id: "shelf_lighting_reenable"
    alias: Shelf Lighting Reenable
    triggers: &any_activity_trigger
      - trigger: state
        entity_id: switch.asus_pc
        to: "on"
      - trigger: state
        entity_id: input_boolean.silent_mode
        to: "off"
      - trigger: state
        entity_id: input_boolean.home_night_mode
        to: "off"
      - trigger: state
        entity_id: person.sen
        to: "home"
      - trigger: numeric_state
        entity_id: sun.sun
        attribute: elevation
        below: 4.0
    conditions:
      - condition: state
        entity_id: light.shelf_lighting
        state: "off"
      - condition: state
        entity_id: person.sen
        state: "home"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: light.turn_on
        entity_id: light.shelf_lighting

  - id: "wireless_charger_reenable"
    alias: Wireless Charger Reenable
    mode: restart
    triggers: *any_activity_trigger
    conditions:
      - condition: state
        entity_id: switch.wireless_charger
        state: "off"
      - condition: state
        entity_id: binary_sensor.people_home
        state: "on"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: switch.turn_on
        entity_id: switch.wireless_charger

  - id: "interactive_cz_map_reenable"
    alias: Interactive CZ Map Reenable
    mode: restart
    triggers: *any_activity_trigger
    conditions:
      - condition: state
        entity_id: switch.interactive_cz_map_enable
        state: "off"
      - condition: state
        entity_id: person.sen
        state: "home"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: switch.turn_on
        entity_id: switch.interactive_cz_map_enable

  - id: "banana_light_reenable"
    alias: Banana Light Reenable
    mode: restart
    triggers: *any_activity_trigger
    conditions:
      - condition: state
        entity_id: light.banana_light
        state: "off"
      - condition: state
        entity_id: person.sen
        state: "home"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: light.turn_on
        entity_id: light.banana_light

  - id: "cocktail_bar_neon_sign_reenable"
    alias: Cocktail Bar Neon Sign Reenable
    mode: restart
    triggers: *any_activity_trigger
    conditions:
      - condition: state
        entity_id: light.cocktail_bar_neon_sign
        state: "off"
      - condition: state
        entity_id: person.sen
        state: "home"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: light.turn_on
        entity_id: light.cocktail_bar_neon_sign
        data:
          brightness: 255

  - id: "kitchen_christmas_lights_reenable"
    alias: Kitchen Christmas Lights Reenable
    mode: restart
    triggers: *any_activity_trigger
    conditions:
      - condition: state
        entity_id: light.kitchen_christmas_lights
        state: "off"
      - condition: state
        entity_id: binary_sensor.people_home
        state: "on"
      - condition: state
        entity_id: input_boolean.home_night_mode
        state: "off"
      - condition: time
        after: "05:00:00"
        before: "22:00:00"
    actions:
      - action: light.turn_on
        entity_id: light.kitchen_christmas_lights

  - id: "disable_decorative_lights_when_sen_leaves"
    alias: Disable Decorative Lights When Sen Leaves
    mode: single
    max_exceeded: silent
    triggers:
      - trigger: state
        entity_id: person.sen
        to: "not_home"
        for: 00:10:00
    actions:
      - action: light.turn_off
        entity_id:
          - light.cocktail_bar_neon_sign
          - light.gyver_lamp
          - light.shelf_lighting
      - action: switch.turn_off
        entity_id:
          - switch.interactive_cz_map_enable
          - switch.ex_commandstation_tracks_power

  - id: "parking_lights_on"
    alias: Parking Lights ON
    mode: queued
    triggers:
      - trigger: state
        entity_id: input_button.parking_light
    actions:
      - action: script.turn_on
        target:
          entity_id: script.switch_on_parking_light

  # Send me notification if switch.parking_light is turned off for more than 1 hour and turn it ON
  - id: "parking_light_emergency_on"
    alias: Parking Light Emergency On
    triggers:
      - trigger: state
        entity_id: switch.parking_light
        to: "off"
        for: 1:00:00
    actions:
      - repeat:
          until:
            - condition: state
              entity_id: switch.parking_light
              state: "on"
          sequence:
            - action: switch.turn_on
              entity_id: switch.parking_light
            - action: notify.mobile_app_sen_s25
              data:
                title: *sys_notify_title_info
                message: –†–µ–ª–µ –æ—Å–≤–µ—â–µ–Ω–∏—è –ø–∞—Ä–∫–æ–≤–∫–∏ –±—ã–ª–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –±–æ–ª–µ–µ —á–∞—Å–∞. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ {{ states('sensor.time') }}
            - delay: 00:01:00

  - id: "kitchen_led_strip_sync_with_spotlights"
    alias: Kitchen LED Strip Sync with Spotlights
    triggers:
      - trigger: state
        entity_id: light.kitchen_spotlights
    conditions:
      - condition: template
        value_template: "{{ trigger.to_state.state in ['on', 'off'] }}"
    actions:
      - action: light.turn_{{ trigger.to_state.state }}
        entity_id: light.kitchen_led_strip

  - id: "activate_night_mode"
    alias: Activate Night Mode
    mode: single
    max_exceeded: silent
    triggers:
      - trigger: state
        entity_id: input_button.activate_night_mode
    actions:
      - action: script.turn_on
        entity_id: script.activate_night_mode

  ###############################################
  ## BUSY WALL SWITCHES
  ###############################################
  - id: "busy_wall_switch_1"
    alias: Busy Wall Switch 1
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.air_quality_station_digital_input_1
        from: "off"
        to: "on"
      - trigger: state
        entity_id: binary_sensor.air_quality_station_digital_input_1
        from: "on"
        to: "off"
    conditions:
      - condition: state
        entity_id: input_boolean.child_lock
        state: "off"
      - condition: state
        entity_id: input_boolean.guest_mode
        state: "off"
    actions:
      - action: light.toggle
        entity_id: light.living_room_ceiling_light

  - id: "busy_wall_switch_2"
    alias: Busy Wall Switch 2
    mode: restart
    triggers:
      - trigger: state
        entity_id: binary_sensor.air_quality_station_digital_input_2
        from: "off"
        to: "on"
      - trigger: state
        entity_id: binary_sensor.air_quality_station_digital_input_2
        from: "on"
        to: "off"
    actions:
      - action: light.toggle
        entity_id: light.floor_lamp

###############################################
## SCENES
###############################################
scene:
  # Common welcome home scene for Sen and Kris
  - id: welcome_home
    name: Welcome Home
    entities:
      light.hall_edison_bulb: on
      light.7_seg_clock: on
      switch.wireless_charger: on

  # Welcome home scene for Sen with additional devices
  - id: welcome_home_sen
    name: Welcome Home Sen
    entities:
      light.banana_light: on
      light.cocktail_bar_neon_sign:
        brightness: 255
        state: on
      switch.wireless_charger: on
      switch.interactive_cz_map_enable: on

  - id: movies
    name: Movies
    entities:
      light.tv_lights: on
      light.floor_lamp: off
      light.gyver_lamp: off
      light.hall_lights: off
      light.kitchen_ceiling_light: off
      light.kitchen_led_strip: off
      light.kitchen_spotlights: off
      light.kitchen_christmas_lights: off
      light.christmas_tree: on
      light.shelf_lighting: off
      light.string_lights: off
      light.banana_light: on
      light.cocktail_bar_neon_sign:
        brightness: 10
        state: on
      media_player.samsung_tv: on
      switch.monolith_speakers: on
      switch.interactive_cz_map_enable: off

  - id: evening
    name: Evening
    entities:
      light.tv_lights: on
      light.bedroom_ceiling_light: off
      light.bedroom_nightlight: off
      light.gyver_lamp:
        brightness: 110
        state: on
      light.hall_lights: off
      light.kitchen_ceiling_light: off
      light.kitchen_led_strip: off
      light.kitchen_spotlights: on
      light.kitchen_christmas_lights: on
      light.christmas_tree: on
      light.mi_desk_lamp:
        brightness: 255
        color_temp_kelvin: 3000
        state: on
      light.pc_backlight: on
      light.shelf_lighting: on
      light.string_lights: on
      light.banana_light: on
      light.cocktail_bar_neon_sign:
        brightness: 3
        state: on
      switch.ex_commandstation_tracks_power: on
      switch.interactive_cz_map_enable: on
