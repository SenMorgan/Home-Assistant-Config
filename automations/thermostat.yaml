######################################################################
# File: thermostat.yaml                                              #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2022-11-30                                                   #
#                                                                    #
# Copyright (c) 2022 Sen Morgan                                      #
######################################################################

- id: "thermostat_change_mode_by_window_state"
  alias: Thermostat Change Mode by Window State
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.windows
      id: Some Window Opened
      from: "off"
      to: "on"
      for: "00:00:05"
    - platform: state
      entity_id: binary_sensor.windows
      id: All Windows Closed
      from: "on"
      to: "off"
      for: "00:00:05"
  condition:
    - condition: state
      entity_id: input_boolean.heating_season_switch
      state: "on"
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: climate.thermostat
                  state: auto
                - condition: state
                  entity_id: climate.thermostat
                  state: heat
            - condition: trigger
              id: Some Window Opened
        - condition: and
          conditions:
            - condition: state
              entity_id: climate.thermostat
              state: "off"
            - condition: trigger
              id: All Windows Closed
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: Some Window Opened
          sequence:
            # - service: media_player.play_media
            #   entity_id: media_player.yandex_station
            #   data:
            #     media_content_id: Термостат отключен
            #     media_content_type: text
            - service: script.thermostat_set_mode
              data:
                mode: "off"
        - conditions:
            - condition: trigger
              id: All Windows Closed
          sequence:
            # - service: media_player.play_media
            #   entity_id: media_player.yandex_station
            #   data:
            #     media_content_id: Термостат будет включен снова через 30 минут
            #     media_content_type: text

            # Wait 30 minutes or stop if some window was opened
            - wait_template: "{{ is_state('binary_sensor.windows', 'on') }}"
              timeout: "00:30:00"
            # Check if all window are still closed
            - condition: state
              entity_id: binary_sensor.windows
              state: "off"
            # - service: media_player.play_media
            #   entity_id: media_player.yandex_station
            #   data:
            #     media_content_id: Термостат включен
            #     media_content_type: text
            - service: script.thermostat_set_mode
              data:
                mode: "heat"

- id: "thermostat_emergency_on"
  alias: Thermostat Emergency ON
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: climate.thermostat
      attribute: current_temperature
      below: 19
      for: "00:05:00"
    - platform: time_pattern
      hours: "/1"
  condition:
    - condition: state
      entity_id: input_boolean.heating_season_switch
      state: "on"
    - condition: numeric_state
      entity_id: climate.thermostat
      attribute: current_temperature
      below: 19
    - condition: state
      entity_id: binary_sensor.people_home
      state: "on"
    - condition: time
      after: "00:00"
      before: "06:00"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Термостат был снова включен в {{ states('sensor.time') }}, чтобы вы не замёрзли
    - service: script.thermostat_set_mode
      data:
        mode: "heat"

- id: "thermostat_10_minutes_heating_on"
  alias: Thermostat 10 Minutes Heating ON
  mode: single
  trigger:
    - platform: state
      entity_id: input_button.thermostat_10_minutes_heating
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: automation.thermostat_10_minutes_heating_off
              state: "on"
          sequence:
            - service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: Подогрев квартиры уже включен
                media_content_type: text
        - conditions:
            - condition: state
              entity_id: automation.thermostat_10_minutes_heating_off
              state: "off"
          sequence:
            # Save actual thermostat target temperature
            - service: input_number.set_value
              data:
                entity_id: input_number.thermostat_saved_target_temperature
                value: "{{ state_attr('climate.thermostat', 'temperature') }}"
            - service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: Включен подогрев квартиры на 10 минут
                media_content_type: text
            - service: script.turn_on
              entity_id: script.tell_what_window_are_opened
            - service: script.thermostat_set_mode
              data:
                mode: "heat"
            - repeat:
                until:
                  - condition: or
                    conditions:
                      - condition: template
                        value_template: "{{ is_state_attr('climate.thermostat', 'temperature', 23) }}"
                      - condition: template
                        # Repeat maximum 10 minutes
                        value_template: "{{ repeat.index >= 10*60/5 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: climate.thermostat
                    data:
                      temperature: 23
                  - delay:
                      seconds: 5
            # Set heating_time_end to a time ten minutes in the future
            - service: input_datetime.set_datetime
              data:
                entity_id: input_datetime.thermostat_10_minutes_heating_time_end
                datetime: "{{ now() + timedelta(minutes=10) }}"
            - service: automation.turn_on
              entity_id: automation.thermostat_10_minutes_heating_off

- id: "thermostat_10_minutes_heating_off"
  alias: Thermostat 10 Minutes Heating OFF
  mode: single
  initial_state: "off"
  trigger:
    # Trigger every 30 seconds
    - platform: time_pattern
      seconds: "/30"
  condition:
    - condition: time
      after: input_datetime.thermostat_10_minutes_heating_time_end
  action:
    - service: media_player.play_media
      entity_id: media_player.yandex_station
      data:
        media_content_id: Подогрев квартиры окончен
        media_content_type: text
    - service: script.thermostat_set_mode
      data:
        mode: "heat"
    # Load last thermostat target temperature
    - repeat:
        until:
          - condition: or
            conditions:
              - condition: template
              # This thermostat model sends values in int format
                value_template:
                  "{{ is_state_attr('climate.thermostat', 'temperature',
                  states('input_number.thermostat_saved_target_temperature') | int) }}"
              - condition: template
                # Repeat maximum 10 minutes
                value_template: "{{ repeat.index >= 10*60/5 }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: climate.thermostat
            data_template:
              temperature: "{{ states('input_number.thermostat_saved_target_temperature') }}"
          - delay:
              seconds: 5
    - service: automation.turn_off
      entity_id: automation.thermostat_10_minutes_heating_off
