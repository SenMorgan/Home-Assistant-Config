######################################################################
# File: home-assistant.yaml                                          #
# Author: SenMorgan https://github.com/SenMorgan                     #
# Date: 2022-11-28                                                   #
#                                                                    #
# Info: this file contains automations that are associated to the    #
# Home Assistant system.                                             #
#                                                                    #
# Copyright (c) 2022 Sen Morgan                                      #
######################################################################

- id: "Notification_Home_Assistant_Started"
  alias: Notification Home Assistant Started
  trigger:
    - platform: homeassistant
      event: start
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Home Assistant started at {{ states('sensor.time') }}

- id: "Notification_Home_Assistant_Stopped"
  alias: Notification Home Assistant Stopped
  trigger:
    - platform: event
      event_type: homeassistant_stop
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Home Assistant stopped at {{ states('sensor.time') }}

- id: "Notification_New_Device_Connected"
  alias: Notification New Device Connected
  mode: queued
  trigger:
    platform: event
    event_type: entity_registry_updated
    event_data:
      action: create
  condition: >
    {{trigger.event.data.entity_id.startswith('device_tracker')}}
  action:
    - variables:
        entity: >
          {{trigger.event.data.entity_id}}
    - service: system_log.write
      data:
        message: >
          New device registrered: {{ entity }}
        level: warning
        logger: homeassistant.components.device_tracker
    - service: persistent_notification.create
      data:
        title: >
          New device registered: {{ entity }}
        message: >
          Entity: {{entity}}
          Host: {{state_attr(entity,'host_name')}}
          Ip: {{state_attr(entity,'ip')}}
          Mac-address: {{state_attr(entity,'mac')}}
          Full data: {{trigger.event.data}}
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: В сети появилось новое устройство {{ entity }}
    - service: media_player.play_media
      entity_id: media_player.yandex_station
      data:
        media_content_id: >
          К локальной сети было подключено новое устройство с именем {{ entity }}
        media_content_type: text

- id: "Notification_Home_Assistant_Update_Available"
  alias: Notification Home Assistant Update Available
  trigger:
    - platform: state
      entity_id: update.home_assistant_core_update
      from: "off"
      to: "on"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Update! Доступна новая версия {{ states('sensor.home_assistant_versions') }}
        data:
          actions:
            - action: "URI"
              title: "Open Config"
              uri: "/config"

###############################################
## Low Battery Notifications
###############################################
- id: "Create_Group_of_Battery_Devices"
  alias: Create Group of Battery Devices
  trigger:
    # Trigger on startup
    - platform: homeassistant
      event: start
    # Trigger every 2 hours by time_pattern
    - platform: time_pattern
      hours: "/2"
  action:
    - service: group.set
      data:
        object_id: battery_devices
        entities: >-
          {%-
            for state in states.sensor
              if is_state_attr(state.entity_id, 'device_class', 'battery') and
              (state.entity_id.endswith("_battery") or state.entity_id.endswith("_power"))
          %}
          {{ state.entity_id }}{%- if not loop.last -%}, {%- endif -%}
          {%- endfor %}

- id: "Notification_Low_Battery"
  alias: Notification Low Battery
  trigger:
    - platform: event
      event_type: state_changed
  condition:
    - condition: template
      value_template: >-
        {{ trigger.event.data.entity_id in (expand('group.battery_devices') | map(attribute='entity_id')) }}
    - condition: template
      value_template: >-
        {{ not trigger.event.data.new_state.state in ['unknown', 'unavailable'] }}
    - condition: template
      value_template: >-
        {{ (trigger.event.data.new_state.state | int) < 20 }}
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: |
          *Внимание, низкий заряд батареи!*
          {{ trigger.event.data.new_state.attributes.friendly_name }}: {{ trigger.event.data.new_state.state }}%!
