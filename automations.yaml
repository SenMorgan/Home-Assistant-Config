###############################################
## Welcome and Hall Lights Automations
###############################################

- id: "Hall_Lights_and_Alice_Greeting"
  alias: Hall Lights and Alice Greeting
  mode: single
  trigger:
    - platform: state
      id: "SEN_CAME_HOME"
      entity_id: person.sen
      to: "home"
    - platform: state
      id: "KRIS_CAME_HOME"
      entity_id: person.kris
      to: "home"
  condition:
    - condition: time
      after: "6:00:00"
      before: "22:00:00"
  action:
    - wait_template: "{{ states('binary_sensor.hall_door_contact') == 'on' }}"
      timeout: 00:15:00
      continue_on_timeout: false
    - wait_template: "{{ states('binary_sensor.hall_door_contact') == 'off' }}"
      timeout: 00:10:00
      continue_on_timeout: false
    - choose:
        # Only Sen came home
        - conditions:
            - condition: trigger
              id: "SEN_CAME_HOME"
            # Check if Kris's state didn't changed after Sen's
            - condition: template
              value_template:
                "{{ ( as_timestamp(states.person.kris.last_changed, 0) | int(0) ) <
                ( as_timestamp(states.person.sen.last_changed, 0) | int(0) ) }}"
          sequence:
            - alias: "Switch on lights and welcome"
              choose:
                - conditions:
                    - condition: sun
                      after: sunset
                      before_offset: 00:15:00
                  sequence:
                    - service: light.turn_on
                      entity_id: light.string_lights
            # Do not notify via Yandex Station if it is in playing state
            - if:
                condition: template
                value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
              then:
                - service: media_player.play_media
                  entity_id: media_player.yandex_station
                  data:
                    media_content_id: >
                      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –¥–æ–º–æ–π –º–∏—Å—Ç–µ—Ä –ú–æ—Ä–≥–∞–Ω!
                    media_content_type: dialog
                    extra:
                      volume_level: 0.6
        # Only Kris came home
        - conditions:
            - condition: trigger
              id: "KRIS_CAME_HOME"
            # Check if Sen's state didn't changed after Kris's
            - condition: template
              value_template:
                "{{ ( as_timestamp(states.person.sen.last_changed, 0) | int(0) ) <
                ( as_timestamp(states.person.kris.last_changed, 0) | int(0) ) }}"
          sequence:
            # Do not notify via Yandex Station if it is in playing state
            - if:
                condition: template
                value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
              then:
                - alias: "Only welcome"
                  service: media_player.play_media
                  entity_id: media_player.yandex_station
                  data:
                    media_content_id: >
                      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –¥–æ–º–æ–π –º–∏—Å—Å–∏—Å –ú–æ—Ä–≥–∞–Ω
                    media_content_type: dialog
                    extra:
                      volume_level: 0.6
        # Bouth came home
        - conditions:
            - condition: state
              entity_id: person.sen
              state: "home"
            - condition: state
              entity_id: person.kris
              state: "home"
          sequence:
            - alias: "Switch on lights and welcome"
              choose:
                - conditions:
                    - condition: sun
                      after: sunset
                      before_offset: 00:15:00
                  sequence:
                    - service: light.turn_on
                      entity_id: light.string_lights
            # Do not notify via Yandex Station if it is in playing state
            - if:
                condition: template
                value_template: "{{ not is_state('media_player.yandex_station', 'playing') }}"
              then:
                - alias: "Welcome everybody"
                  service: media_player.play_media
                  entity_id: media_player.yandex_station
                  data:
                    media_content_id: >
                      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –¥–æ–º–æ–π –º–∏—Å—Ç–µ—Ä –∏ –º–∏—Å—Å–∏—Å –ú–æ—Ä–≥–∞–Ω
                    media_content_type: dialog
                    extra:
                      volume_level: 0.6
      default:
        - service: notify.mobile_app_sm_s901b
          data:
            title: "{{ '‚ÑπÔ∏è' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
            message: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–µ —Å–º–æ–≥–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫—Ç–æ –ø—Ä–∏—à–µ–ª - –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥

- id: "Home_All_Lights_OFF"
  alias: Home All Lights OFF
  trigger:
    - platform: state
      entity_id: binary_sensor.hall_door_contact
      from: "on"
      to: "off"
  condition:
    - condition: state
      entity_id: binary_sensor.people_home
      state: "on"
  action:
    - wait_template: "{{ states('binary_sensor.people_home') == 'off' }}"
      timeout: "00:30:00"
      continue_on_timeout: false
    - service: light.turn_off
      entity_id: all
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üëã' }} –î–æ —Å–≤–∏–¥–∞–Ω–∏—è"
        message: >
          {% if is_state('input_boolean.heating_season', 'on') %}
            –¢–µ—Ä–º–æ—Å—Ç–∞—Ç –∏ —Å–≤–µ—Ç –±—ã–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
          {% else %}
            –í–µ—Å—å —Å–≤–µ—Ç –±—ã–ª –æ—Ç–∫–ª—é—á–µ–Ω
          {% endif %}

- id: "Hall_Lights_by_Motion_ON"
  alias: Hall Lights by Motion ON
  trigger:
    - platform: state
      entity_id: binary_sensor.hall_door_contact
      to: "on"
    - platform: state
      entity_id: binary_sensor.aqara_hall_motion_sensor_occupancy
      to: "on"
  condition:
    - condition: state
      entity_id: light.hall_lights
      state: "off"
  action:
    - service: light.turn_on
      entity_id: light.hall_lights
    - service: input_boolean.turn_on
      entity_id: input_boolean.flag_hall_lights_triggered_by_motion

- id: "Hall_Lights_by_Motion_OFF"
  alias: Hall Lights by Motion OFF
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_hall_motion_sensor_occupancy
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.flag_hall_lights_triggered_by_motion
      state: "on"
  action:
    - service: light.turn_off
      entity_id: light.hall_lights
    - service: input_boolean.turn_off
      entity_id: input_boolean.flag_hall_lights_triggered_by_motion

###############################################
## Other Automatic Lights
###############################################

- id: "Kitchen_Asus_PC_Background_Lights_ON"
  alias: Kitchen Asus PC Background Lights ON
  trigger:
    - platform: sun
      id: "SUNSET"
      event: sunset
      offset: -00:25:00
    - platform: state
      id: "PC_ON"
      entity_id: switch.asus_pc
      from: "off"
      to: "on"
  condition:
    - condition: state
      entity_id: person.sen
      state: "home"
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: trigger
              id: "SUNSET"
            - condition: state
              entity_id: switch.asus_pc
              state: "on"
        - condition: and
          conditions:
            - condition: trigger
              id: "PC_ON"
  #            - condition: sun
  #              after: sunset
  #              after_offset: -00:25:00
  action:
    - service: light.turn_on
      entity_id:
        - light.gyver_lamp
    - if:
        - condition: template
          value_template: >
            {{ states('person.kris') == 'home'}}
      then:
        - service: switch.turn_off
          entity_id:
            - switch.pc_backlight_sync_send
      else:
        - service: light.turn_on
          entity_id:
            - light.shelf_lighting
            - light.pc_backlight
        - service: switch.turn_on
          entity_id:
            - switch.pc_backlight_sync_send

- id: "Kitchen_Asus_PC_Background_Lights_OFF"
  alias: Kitchen Asus PC Background Lights OFF
  trigger:
    - platform: state
      entity_id: switch.asus_pc
      from: "on"
      to: "off"
  action:
    - service: light.turn_off
      entity_id:
        - light.gyver_lamp
        - light.shelf_lighting

- id: "Kitchen_Clock_On_if_People_Home"
  alias: Kitchen Clock On if People Home
  trigger:
    platform: state
    entity_id: binary_sensor.people_home
    to: "on"
  action:
    - service: light.turn_on
      entity_id: light.7_seg_clock

- id: "Living_Room_Bar_Lights_by_Sunset_or_TV_ON"
  alias: Living Room Bar Lights by Sunset or TV ON
  trigger:
    - platform: sun
      id: "SUNSET"
      event: sunset
      offset: -00:15:00
    - platform: state
      id: "TV_ON"
      entity_id: media_player.tv
      to: "on"
  condition:
    - condition: state
      entity_id: person.sen
      state: "home"
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: trigger
              id: "SUNSET"
            - condition: state
              entity_id: media_player.tv
              state: "on"
        - condition: and
          conditions:
            - condition: trigger
              id: "TV_ON"
            - condition: sun
              after: sunset
              before_offset: 00:15:00
  action:
    - wait_template: >
        "{{ states('switch.asus_pc') == 'off' and
            states('light.mi_desk_lamp') == 'off' and
            states('light.kitchen_spotlights') == 'off' and
            states('light.bedroom_nightlight') == 'off' }}"
      timeout: 01:00:00
      continue_on_timeout: false
    # Check if it's still needed (TV is on)
    - if:
        - condition: state
          entity_id: media_player.tv
          state: "on"
      then:
        - service: scene.turn_on
          entity_id: scene.movies

- id: "Living_Room_Bar_Lights_by_Sunrise_OFF"
  alias: Living Room Bar Lights by Sunrise OFF
  trigger:
    - platform: sun
      event: sunrise
      offset: -01:00:00
  action:
    - service: light.turn_off
      entity_id: light.bar_light

- id: "Kids_Playground_By_Motion_ON"
  alias: Kids Playground By Motion ON
  trigger:
    - platform: state
      entity_id: binary_sensor.kids_playground_motion_occupancy
      to: "on"
  condition:
    - condition: time
      after: "07:00:00"
      before: "20:00:00"
    # If floor lamp is off
    - condition: state
      entity_id: light.floor_lamp
      state: "off"
    # If it has been more than 10 minutes since the last time the light was turned on
    - condition: template
      value_template: >
        {{ (as_timestamp(now()) - as_timestamp(states.automation.kids_playground_by_motion_on.last_changed, 0)) > 600 }}
    # If it has been more than 10 minutes since the last time floor lamp was triggered
    - condition: template
      value_template: >
        {{ (as_timestamp(now()) - as_timestamp(states.light.floor_lamp.last_changed, 0)) > 600 }}
  action:
    - service: light.turn_on
      entity_id: light.floor_lamp

# Commit message: feat: add automation to turn on the light when the motion sensor is triggered

# Send me notification if switch.parking_light is turned off for more than 1 hour and turn it ON
- id: "Parking_Light_Emergency_On"
  alias: Parking Light Emergency On
  trigger:
    - platform: state
      entity_id: switch.parking_light
      to: "off"
      for: 1:00:00
  action:
    - repeat:
        until:
          - condition: state
            entity_id: switch.parking_light
            state: "on"
        sequence:
          - service: switch.turn_on
            entity_id: switch.parking_light
          - service: notify.mobile_app_sm_s901b
            data:
              title: "{{ 'üöó' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
              message: –†–µ–ª–µ –æ—Å–≤–µ—â–µ–Ω–∏—è –ø–∞—Ä–∫–æ–≤–∫–∏ –±—ã–ª–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ –±–æ–ª–µ–µ —á–∞—Å–∞. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤ {{ states('sensor.time') }}
          - delay: 00:01:00

###############################################
## Cover Automations
###############################################

- id: "Bedroom_Blinds_by_Sunset_Close"
  alias: Bedroom Blinds by Sunset Close
  trigger:
    - platform: sun
      event: sunset
      offset: 00:20:00
  condition:
    - condition: state
      entity_id: cover.bedroom
      state: open
    # - condition: state
    #   entity_id: binary_sensor.bedroom_window_contact
    #   state: "off"
  action:
    - service: cover.close_cover
      entity_id: cover.bedroom

###############################################
## Notifications
###############################################

- id: "Notification_Kris_Arrived"
  alias: Notification Kris Arrived
  trigger:
    - platform: state
      entity_id: person.kris
      to: "home"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üë©‚Äçü¶∞' }} –°–µ–º–µ–π–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –ö—Ä–∏—Å—Ç–∏–Ω–∞ –ø—Ä–∏—à–ª–∞ –¥–æ–º–æ–π –≤ {{ states('sensor.time') }}
    - choose:
        - conditions:
            - condition: state
              entity_id: person.sen
              state: "home"
            - condition: state
              entity_id: switch.asus_pc
              state: "on"
          sequence:
            - service: select.select_option
              target:
                entity_id: select.pc_backlight_preset
              data:
                option: "Alarm"
            - delay: 00:00:20
            - service: select.select_option
              target:
                entity_id: select.pc_backlight_preset
              data:
                option: "Gender"

- id: "Notification_Kris_Leaved"
  alias: Notification Kris Leaved
  trigger:
    - platform: state
      entity_id: person.kris
      from: "home"
      to: "not_home"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üë©‚Äçü¶∞' }} –°–µ–º–µ–π–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –ö—Ä–∏—Å—Ç–∏–Ω–∞ —É—à–ª–∞ –≤ {{ states('sensor.time') }}

- id: "Notification_Kris_Is_Near_Me"
  alias: Notification Kris Is Near Me
  trigger:
    - platform: numeric_state
      entity_id: sensor.distance_between_kris_and_sen
      below: 200
  condition:
    - condition: template
      value_template: "{{ not states('person.kris') == 'home' }}"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üë©‚Äçü¶∞' }} –°–µ–º–µ–π–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –ö—Ä–∏—Å—Ç–∏–Ω–∞ –≤ {{ states('sensor.distance_between_kris_and_sen') }} –º–µ—Ç—Ä–∞—Ö –æ—Ç –í–∞—Å –≤ {{ states('sensor.time') }}

- id: "Notification_Snow"
  alias: Notification Snow
  trigger:
    - platform: numeric_state
      entity_id: sensor.openweathermap_snow
      above: 0
  action:
    - service: notify.mobile_app_sm_s901b
      data_template:
        title: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–Ω–µ–≥–µ
        message: –î–æ–ª–∂–Ω–æ –≤—ã–ø–∞—Å—Ç—å {{ states('sensor.openweathermap_snow') }} –º–º —Å–Ω–µ–≥–∞

- id: "Notification_Door_Opened"
  alias: Notification Door Opened
  trigger:
    - platform: state
      entity_id: binary_sensor.hall_door_contact
      to: "on"
  condition:
    - condition: template
      value_template: >
        {{ not states('person.sen') == 'home'}}
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ÑπÔ∏è' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –í—Ö–æ–¥–Ω–∞—è –¥–≤–µ—Ä—å –±—ã–ª–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ {{ states('sensor.time') }}

- id: "Notification_Gas_Leakage_Detected"
  alias: Notification Gas Leakage Detected
  trigger:
    - platform: state
      entity_id: binary_sensor.co_and_natural_gas_alarm_gas
      to: "on"
  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.co_and_natural_gas_alarm_gas
            state: "on"
        sequence:
          - service: notify.mobile_app_sm_s901b
            data:
              title: "{{ 'üö®' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
              message: >
                –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –≥–∞–∑–∞ –≤ {{ states('sensor.time') }}
                –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≥–∞–∑–∞: {{ states('sensor.co_and_natural_gas_alarm_gas') }} ppm
              data:
                ttl: 0
                priority: urgent
                channel: alarm_stream
                importance: high
                persistent: true
                tag: "persistent"
          - delay: 00:00:10

- id: "Notification_Carbon_Monoxide_Detected"
  alias: Notification Carbon Monoxide Detected
  trigger:
    - platform: state
      entity_id: binary_sensor.co_and_natural_gas_alarm_carbon_monoxide
      to: "on"
  action:
    - repeat:
        while:
          - condition: state
            entity_id: binary_sensor.co_and_natural_gas_alarm_carbon_monoxide
            state: "on"
        sequence:
          - service: notify.mobile_app_sm_s901b
            data:
              title: "{{ 'üö®' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
              message: >
                –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤—ã—Å–æ–∫–∞—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —É–≥–∞—Ä–Ω–æ–≥–æ –≥–∞–∑–∞ –≤ {{ states('sensor.time') }}
                –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –≥–∞–∑–∞: {{ states('sensor.co_and_natural_gas_alarm_carbon_monoxide') }} ppm
          - delay: 00:00:10

- id: "Notification_ADS_B_Receiver_Disconnected"
  alias: Notification ADS-B Receiver Disconnected
  trigger:
    - platform: state
      entity_id: binary_sensor.fr24_feeder_receiver_connected
      from: "on"
      to: "off"
  action:
    - service: persistent_notification.create
      data:
        title: "{{ '‚ùóÔ∏è' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –°–≤—è–∑—å —Å ADS-B –ø—Ä–∏—ë–º–Ω–∏–∫–æ–º –±—ã–ª–∞ –ø–æ—Ç–µ—Ä—è–Ω–∞ –≤ {{ states('sensor.time') }}
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ùóÔ∏è' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –°–≤—è–∑—å —Å ADS-B –ø—Ä–∏—ë–º–Ω–∏–∫–æ–º –±—ã–ª–∞ –ø–æ—Ç–µ—Ä—è–Ω–∞ –≤ {{ states('sensor.time') }}

- id: "Notification_ADS_B_Receiver_Connected"
  alias: Notification ADS-B Receiver Connected
  trigger:
    - platform: state
      entity_id: binary_sensor.fr24_feeder_receiver_connected
      from: "off"
      to: "on"
  action:
    - service: persistent_notification.create
      data:
        title: "{{ '‚ÑπÔ∏è' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –°–≤—è–∑—å —Å ADS-B –ø—Ä–∏—ë–º–Ω–∏–∫–æ–º –±—ã–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ {{ states('sensor.time') }}
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ÑπÔ∏è' }} –°–∏—Å—Ç–µ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
        message: –°–≤—è–∑—å —Å ADS-B –ø—Ä–∏—ë–º–Ω–∏–∫–æ–º –±—ã–ª–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ {{ states('sensor.time') }}

- id: "Notification_Diesel_Price_Changed"
  alias: Notification Diesel Price Changed
  trigger:
    - platform: state
      entity_id: sensor.diesel_price_ono
  condition:
    - condition: template
      value_template: >
        {{ trigger.from_state.state != trigger.to_state.state }}
    - condition: template
      value_template: >
        {{ is_number(trigger.from_state.state) and is_number(trigger.to_state.state) }}
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üöó' }} –¶–µ–Ω–∞ —Ç–æ–ø–ª–∏–≤–∞"
        message: >
          –¶–µ–Ω–∞ –¥–∏–∑–µ–ª—è {{ '—É–ø–∞–ª–∞' if trigger.from_state.state | float > trigger.to_state.state | float else '–≤–æ–∑—Ä–∞—Å–ª–∞' }}
          —Å {{ trigger.from_state.state }} –¥–æ {{ trigger.to_state.state }} Kƒç/L

- id: "Notification_Aircraft_Detected"
  alias: Notification Aircraft Detected
  trigger:
    - platform: state
      entity_id: sensor.fr24_aircraft
  condition:
    - condition: template
      value_template: !secret AIRCRAFTS_TO_TRACK_CONDITION_TEMPLATE
      # Do not forget to add this line to secrets.yaml file and replace OK*** with your aircraft registration number:
      # AIRCRAFTS_TO_TRACK_CONDITION_TEMPLATE: {{ state_attr('sensor.fr24_aircraft', 'aircraft') | regex_search('OK***|OK***') }}
    - condition: template
      value_template: >
        {{ now() - state_attr('automation.notification_aircraft_detected', 'last_triggered') > timedelta(minutes=5) }}
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚úàÔ∏è' }} –ü—Ä–æ–ª–µ—Ç–∞–µ—Ç –∑–Ω–∞–∫–æ–º—ã–π —Å–∞–º–æ–ª—ë—Ç"
        message: !secret AIRCRAFTS_TO_TRACK_MESSAGE_TEMPLATE

        # There is no other way to hide aircrafts registration number from code in secrets.yaml and use it in template,
        # so I have to save all code in the secrets.yaml file:
        # AIRCRAFTS_TO_TRACK_MESSAGE_TEMPLATE: |
        # {% set aircraft = namespace(flight='', alt_baro='', gs='') %}
        # {% set aircrafts_list = state_attr('sensor.fr24_aircraft', 'aircraft') %}
        # {% for element in aircrafts_list if element | regex_search('OK***|OK***') %} # DO NOT FORGET TO CHANGE AIRCRAFTS REGISTRATION NUMBER
        #         {% set aircraft.flight = element['flight'] %}
        #         {% set aircraft.alt = (((element['alt_baro'] | float) * 0.3048) | int) | string %}
        #         {% set aircraft.gs = (((element['gs'] | float) * 1.852) | int) | string %}
        # {% endfor %}
        # {% if aircraft.flight == '' %}
        #         {{ '–î–∞–Ω–Ω—ã–µ –æ —Å–∞–º–æ–ª—ë—Ç–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã' }}
        # {% else %}
        #         {{ '–ù–æ–º–µ—Ä —Ä–µ–π—Å–∞: ' + aircraft.flight }}
        #         {{ '–í—ã—Å–æ—Ç–∞: ' + aircraft.alt + ' –º' }}
        #         {{ '–°–∫–æ—Ä–æ—Å—Ç—å: ' + aircraft.gs + ' –∫–º/—á' }}
        # {% endif %}

###############################################
## Raven Notifications
###############################################

- id: "Notification_Raven_Connected"
  alias: Notification Raven Connected
  trigger:
    - platform: state
      entity_id: person.raven
      to: "home"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ÑπÔ∏è' }} –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Raven"
        message: Raven –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É

- id: "Notification_Raven_Disconnected"
  alias: Notification Raven Disconnected
  trigger:
    - platform: state
      entity_id: person.raven
      to: "not_home"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ÑπÔ∏è' }} –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Raven"
        message: Raven –æ—Ç–∫–ª—é—á–∏–ª—Å—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

- id: "Notification_Raven_Alarm"
  alias: Notification Raven Alarm
  trigger:
    - platform: state
      entity_id: binary_sensor.raven_alarm
      from: "off"
      to: "on"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ùóÔ∏è' }} –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Raven"
        message: –ù–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –≤ Raven –≤ {{ states('sensor.time') }}

- id: "Notification_Raven_Low_Battery"
  alias: Notification Raven Low Battery
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: sensor.raven_battery_voltage
      below: 12.2
      for: "00:00:30"
  action:
    - alias: "Set up variables for the actions"
      variables:
        # Including an id in the action allows us to identify this script run
        # and not accidentally trigger for other notification actions
        action_start_charging: "{{ 'START_CHARGING_' ~ context.id }}"
    - alias: "Ask to ask to start charging"
      service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ùóÔ∏è' }} –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Raven"
        message: –ù–∏–∑–∫–æ–µ –±–æ—Ä—Ç–æ–≤–æ–µ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ - {{ states('sensor.raven_battery_voltage') }}V
        data:
          actions:
            - action: "{{ action_start_charging }}"
              title: "Start Charging"
            - action: "URI"
              title: "Open URI"
              uri: "/lovelace/raven"
    - alias: "Wait for a response"
      wait_for_trigger:
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            # waiting for the specific action avoids accidentally continuing
            # for another script/automation's notification action
            action: "{{ action_start_charging }}"
    - alias: "Perform the action"
      choose:
        - conditions: "{{ wait.trigger.event.data.action == action_start_charging }}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.backyard_socket

- id: "Notification_Raven_Not_Sleeping"
  alias: Notification Raven Not Sleeping
  mode: restart
  trigger:
    - platform: state
      entity_id: sensor.raven_actual_mode
      to: "0"
      for: "00:05:00"
    - platform: state
      entity_id: lock.raven_locks
      to: "locked"
      for: "00:05:00"
    - platform: state
      entity_id: binary_sensor.raven_sleep_mode
      to: "off"
      for: "00:05:00"
  condition:
    - condition: state
      entity_id: sensor.raven_actual_mode
      state: "0"
    - condition: state
      entity_id: lock.raven_locks
      state: "locked"
    - condition: state
      entity_id: binary_sensor.raven_sleep_mode
      state: "off"
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ '‚ùóÔ∏è' }} –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Raven"
        message: CAN-BUS –Ω–µ –∑–∞—Å—ã–ø–∞–µ—Ç! –ü—Ä–∏–º–∏—Ç–µ –º–µ—Ä—ã!
        data:
          actions:
            - action: "URI"
              title: "Open URI"
              uri: "/lovelace/raven"

###############################################
## Aqara Cube Automations
###############################################

- id: "Aqara_Cube_Flip_90"
  alias: Aqara Cube Flip 90
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "flip90"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.toggle
      entity_id: light.string_lights

- id: "Aqara_Cube_Flip_180"
  alias: Aqara Cube Flip 180
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "flip180"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.toggle
      entity_id: light.floor_lamp

- id: "Aqara_Cube_Shake"
  alias: Aqara Cube Shake
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "shake"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.turn_off
      entity_id: all

- id: "Aqara_Cube_Tap"
  alias: Aqara Cube Tap
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "tap"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: scene.turn_on
      entity_id: scene.movies

- id: "Aqara_Cube_Slide"
  alias: Aqara Cube Slide
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "slide"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.toggle
      entity_id: light.mi_desk_lamp

- id: "Aqara_Cube_Rotate"
  alias: Aqara Cube Rotate
  mode: single
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "rotate_left"
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "rotate_right"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.turn_on
      entity_id: light.mi_desk_lamp
      data_template:
        brightness:
          "{% set suggested = state_attr('light.mi_desk_lamp', 'brightness')\
          \ | int + \n  state_attr('sensor.aqara_cube_1_action', 'angle') | int + 1\
          \ %}\n{% if suggested > 0 %} {{ suggested }} {% else %} 1 {% endif %}\n"

###############################################
## Aqara Switch Automations
###############################################

- id: "Bedroom_Aqara_Switch_Single_Press"
  alias: Bedroom Aqara Switch Single Press
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "single"
  action:
    - service: light.turn_off
      entity_id: all
    - service: scene.turn_on
      entity_id: scene.good_night
    - service: script.turn_on
      entity_id: script.home_night_mode

- id: "Bedroom_Aqara_Switch_Double_Press"
  alias: Bedroom Aqara Switch Double Press
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "double"
  action:
    - service: light.turn_on
      entity_id: light.bedroom_nightlight

- id: "Bedroom_Aqara_Switch_Triple_Press"
  alias: Bedroom Aqara Switch Triple Press
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "triple"
  action:
    - service: switch.turn_off
      entity_id: switch.asus_pc

- id: "Bedroom_Aqara_Switch_Hold"
  alias: Bedroom Aqara Switch Hold
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "hold"
  action:
    - service: cover.open_cover
      entity_id: cover.bedroom
    - service: script.turn_on
      entity_id: script.home_day_mode

###############################################
## Floorlamp Tradfri Switch Control
###############################################

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_ON"
  alias: Living Room Floorlamp Tradfri Switch Control ON
  mode: restart
  trigger:
    platform: state
    entity_id: sensor.tradfri_switch_action
    to: "on"
  action:
    - service: light.turn_on
      entity_id: light.floor_lamp

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_OFF"
  alias: Living Room Floorlamp Tradfri Switch Control OFF
  mode: restart
  trigger:
    platform: state
    entity_id: sensor.tradfri_switch_action
    to: "off"
  action:
    - service: light.turn_off
      entity_id: light.floor_lamp

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_Brightness_Up"
  alias: Floorlamp Tradfri Switch Control Brightness Up
  trigger:
    - platform: state
      entity_id: sensor.tradfri_switch_action
      to: "brightness_move_up"
  condition:
    - condition: state
      entity_id: light.floor_lamp
      state: "on"
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.light_brightness
    - service: python_script.change_attribute_light_smoothly
      data:
        light_id: light.floor_lamp
        input_boolean: input_boolean.light_brightness
        delta: 10

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_Brightness_Down"
  alias: Living Room Floorlamp Tradfri Switch Control Brightness Down
  trigger:
    - platform: state
      entity_id: sensor.tradfri_switch_action
      to: "brightness_move_down"
  condition:
    - condition: state
      entity_id: light.floor_lamp
      state: "on"
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.light_brightness
    - service: python_script.change_attribute_light_smoothly
      data:
        light_id: light.floor_lamp
        input_boolean: input_boolean.light_brightness
        delta: -10

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_Brightness_Controll_OFF"
  alias: Living Room Floorlamp Tradfri Switch Control Brightness Controll OFF
  trigger:
    - platform: state
      entity_id: sensor.tradfri_switch_action
      to: brightness_stop
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.light_brightness
        state: "on"
      - condition: state
        entity_id: light.floor_lamp
        state: "on"
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.light_brightness

###############################################
## Media Players Control
###############################################

- id: "Living_Room_TV_by_WoL_ON"
  alias: Living Room TV by WoL ON
  mode: restart
  trigger:
    - platform: webostv.turn_on
      entity_id: media_player.tv
  action:
    - service: script.turn_on
      entity_id: script.wake_tv

###############################################
## Other Buttons and Switches Handles
###############################################

- id: "Raven_Engine_Switch"
  alias: Raven Engine Switch
  mode: single
  trigger:
    - platform: state
      id: START_ENGINE
      entity_id: input_boolean.raven_engine_start_stop
      to: "on"
    - platform: state
      id: STOP_ENGINE
      entity_id: input_boolean.raven_engine_start_stop
      to: "off"
  condition:
    - condition: state
      entity_id: script.start_raven_engine_with_repeat
      state: "off"
    - condition: state
      entity_id: script.stop_raven_engine_with_repeat
      state: "off"
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: START_ENGINE
            - condition: numeric_state
              entity_id: sensor.raven_motor_rpm
              below: 1
          sequence:
            - service: script.turn_on
              entity_id: script.start_raven_engine_with_repeat
        - conditions:
            - condition: trigger
              id: STOP_ENGINE
          sequence:
            - service: script.turn_on
              entity_id: script.stop_raven_engine_with_repeat

- id: "Raven_Engine_State_Handler"
  alias: Raven Engine State Handler
  trigger:
    - platform: state
      entity_id: sensor.raven_started_by_status
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: sensor.raven_started_by_status
                  state: "KEY"
                - condition: state
                  entity_id: sensor.raven_started_by_status
                  state: "REMOTE"
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.raven_engine_start_stop
        - conditions:
            - condition: state
              entity_id: sensor.raven_started_by_status
              state: "OFF"
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.raven_engine_start_stop

- id: "Parking_Lights_ON"
  alias: Parking Lights ON
  mode: single
  trigger:
    - platform: state
      entity_id: input_button.parking_light
  action:
    - service: script.turn_on
      target:
        entity_id: script.switch_on_parking_light

- id: "Kitchen_Presentation_ON"
  alias: Kitchen Presentation ON
  trigger:
    - platform: state
      entity_id: input_boolean.presentation_switch
      to: "on"
  condition:
    - condition: state
      entity_id: script.presentation
      state: "off"
  action:
    - service: script.turn_on
      target:
        entity_id: script.presentation
    - service: input_boolean.turn_off
      entity_id: input_boolean.presentation_switch

###############################################
## Yandex Alice Automations
###############################################

- id: "Sync_Shopping_List"
  alias: Sync Shopping List
  mode: single
  trigger:
    - platform: state
      entity_id: person.sen
      from: "home"
      to: "not_home"
  action:
    # Save actual volume
    - service: input_number.set_value
      target:
        entity_id: input_number.volume_yandex_station
      data:
        value: "{{ state_attr('media_player.yandex_station', 'volume_level')}}"
    # Repeat the command to ensure that the volume is muted
    - repeat:
        while:
          - condition: template
            value_template: "{{ not is_state_attr('media_player.yandex_station', 'volume_level', 0.01) }}"
          - condition: template
            value_template: "{{ repeat.index <= 3 }}"
        sequence:
          - service: media_player.volume_set
            data:
              entity_id: media_player.yandex_station
              volume_level: 0.01
          - delay: 0.5
    - service: script.turn_on
      entity_id: script.update_shopping_list
    - delay: 1
    - service: media_player.play_media
      entity_id: media_player.yandex_station
      data:
        media_content_id: stop
        media_content_type: command
    - delay: 1
    # Repeat the command to ensure that the volume is muted
    - repeat:
        while:
          - condition: template
            value_template: "{{ not is_state_attr('media_player.yandex_station', 'volume_level', states('input_number.volume_yandex_station')) }}"
          - condition: template
            value_template: "{{ repeat.index <= 3 }}"
        sequence:
          - service: media_player.volume_set
            data:
              entity_id: media_player.yandex_station
              volume_level: "{{ states('input_number.volume_yandex_station')}}"
          - delay: 1

- id: "Home_Enable_Night_Mode_by_Bedroom_Door"
  alias: Home Enable Night Mode by Bedroom Door
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_door_contact
      from: "on"
      to: "off"
      for: 00:00:30
    - platform: time
      at: "21:00:00"
  condition:
    - condition: time
      after: "20:00:00"
      before: "03:00:00"
      # Don not check here ¬´input_boolean.home_night_mode¬ª state, because
      # we need to ensure that the night mode will be turned ON at 21:00
  action:
    service: input_boolean.turn_on
    entity_id: input_boolean.home_night_mode

- id: "Kitchen_Yandex_Volume_Increased_Trigger"
  alias: Kitchen Yandex Volume Increased Trigger
  mode: single
  trigger:
    - platform: state
      entity_id: media_player.yandex_station
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "on"
    - condition: template
      value_template: >
        {% set from = trigger.from_state.attributes.volume_level | float %}
        {% set to = trigger.to_state.attributes.volume_level | float %}
        {{ to > from }}
  action:
    service: input_boolean.turn_off
    entity_id: input_boolean.home_night_mode

- id: "Home_Disable_Night_Mode_by_Trigger"
  alias: Home Disable Night Mode by Trigger
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_door_contact
      from: "off"
      to: "on"
      for: 00:00:30
    - platform: time
      at: "09:00:00"
    - platform: state
      entity_id: cover.bedroom_cover
      to: "open"
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "on"
    - condition: time
      after: "06:00:00"
      before: "12:00:00"
    - condition: state
      entity_id: binary_sensor.bedroom_door_contact
      state: "on"
  action:
    service: input_boolean.turn_off
    entity_id: input_boolean.home_night_mode

- id: "Home_Night_Mode_ON"
  alias: Home Night Mode ON
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.home_night_mode
      from: "off"
      to: "on"
  action:
    service: script.turn_on
    entity_id: script.home_night_mode

- id: "Home_Night_Mode_OFF"
  alias: Home Night Mode OFF
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.home_night_mode
      from: "on"
      to: "off"
  action:
    service: script.turn_on
    entity_id: script.home_day_mode

# Reduce Yandex Station volume if door was closed and restore if opened during the day time
- id: "Kitchen_Yandex_Reduce_Volume_If_Bedroom_Door_Closed"
  alias: Kitchen Yandex Reduce Volume If Bedroom Door Closed
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_door_contact
      from: "on"
      to: "off"
      for: 00:00:30
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "off"
  action:
    - repeat:
        while:
          - condition: template
            value_template: "{{ not is_state_attr('media_player.yandex_station', 'volume_level', 0.2) }}"
          - condition: template
            value_template: "{{ repeat.index <= 3 }}"
        sequence:
          - service: media_player.volume_set
            data:
              entity_id: media_player.yandex_station
              volume_level: 0.2
          - delay: 1

- id: "Kitchen_Yandex_Restore_Volume_If_Bedroom_Door_Opened"
  alias: Kitchen Yandex Restore Volume If Bedroom Door Opened
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_door_contact
      from: "off"
      to: "on"
      for: 00:00:30
  condition:
    - condition: state
      entity_id: input_boolean.home_night_mode
      state: "off"
  action:
    - repeat:
        while:
          - condition: template
            value_template: "{{ not is_state_attr('media_player.yandex_station', 'volume_level', 0.6) }}"
          - condition: template
            value_template: "{{ repeat.index <= 3 }}"
        sequence:
          - service: media_player.volume_set
            data:
              entity_id: media_player.yandex_station
              volume_level: 0.6
          - delay: 1

###############################################
## Solar Station Automations
###############################################

- id: "Save_Energy_Produced_Value_at_Start_of_the_Day"
  alias: Save Energy Produced Value at Start of the Day
  trigger:
    platform: time
    at: "00:00:00"
  action:
    service: input_number.set_value
    data_template:
      entity_id: input_number.solar_energy_produced_at_beginning_of_day
      value: "{{ states('sensor.solar_panel_energy') }}"

###############################################
## Energy Meter Automations
###############################################

- id: "Save_Energy_Consumed_Value_at_Start_of_the_Day"
  alias: Save Energy Consumed Value at Start of the Day
  trigger:
    platform: time
    at: "00:00:00"
  action:
    service: input_number.set_value
    data_template:
      entity_id: input_number.energy_consumed_at_beginning_of_day
      value: "{{ states('sensor.electricity_meter_energy') }}"

###############################################
## Gas Meter by Aqara door sensor and counter
###############################################

- id: "Gas_Counting"
  alias: Gas Counting
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.bedroom_window_contact
      from: "off"
      to: "on"
  action:
    - service: counter.increment
      target:
        entity_id: counter.gas_counter
  mode: single

###############################################
## Other Automatations
###############################################

- alias: Power Monitor Crossed Low Threshold Notification
  id: "power_monitor_crossed_low_threshold_notification"
  trigger:
    - platform: numeric_state
      entity_id: sensor.power_monitor_voltage
      below: input_number.power_monitor_low_voltage_threshold
  action:
    - repeat:
        while:
          - condition: numeric_state
            entity_id: sensor.power_monitor_voltage
            below: input_number.power_monitor_low_voltage_threshold
        sequence:
          - service: notify.mobile_app_sm_s901b
            data:
              title: "{{ 'üö®' }} –ú–æ–Ω–∏—Ç–æ—Ä –ø–∏—Ç–∞–Ω–∏—è"
              message: "–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞: {{ states('sensor.power_monitor_voltage') }} V"
          - delay: 00:05:00

- alias: Solar Panel Power Above 45W
  id: "Solar_Panel_Power_Above_45W"
  trigger:
    - platform: numeric_state
      entity_id: sensor.solar_panel_power
      above: 45
  action:
    - service: notify.mobile_app_sm_s901b
      data:
        title: "{{ 'üåû' }} –°–æ–ª–Ω–µ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å"
        message: "–ú–æ—â–Ω–æ—Å—Ç—å –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞: {{ states('sensor.solar_panel_power') }} W"
