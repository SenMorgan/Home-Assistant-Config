###############################################
## Welcome and Hall Lights Automations
###############################################

- id: "Hall_Lights_and_Alice_Greeting"
  alias: Hall Lights and Alice Greeting
  mode: queued
  trigger:
    - platform: state
      entity_id: person.sen
      to: "home"
    - platform: state
      entity_id: person.kris
      to: "home"
  condition:
    - condition: time
      after: "6:00:00"
      before: "22:00:00"
  action:
    - wait_template: "{{ states('binary_sensor.aqara_hall_door_sensor_contact') == 'on' }}"
      timeout: 00:15:00
      continue_on_timeout: false
    - wait_template: "{{ states('binary_sensor.aqara_hall_door_sensor_contact') == 'off' }}"
      timeout: 00:10:00
    - choose:
        # Only Sen came home
        - conditions:
            - condition: state
              entity_id: person.sen
              state: "home"
          sequence:
            - alias: "Switch on lights and welcome"
              choose:
                - conditions:
                    - condition: sun
                      after: sunset
                      before_offset: 00:15:00
                  sequence:
                    - service: switch.turn_on
                      entity_id: switch.string_lights
            - service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: >
                  Добро пожаловать домой мистер Морган!
                media_content_type: dialog
                extra:
                  volume_level: 0.9
        # Only Kris came home
        - conditions:
            - condition: state
              entity_id: person.kris
              state: "home"
          sequence:
            - alias: "Only welcome"
              service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: >
                  Добро пожаловать домой миссис Морган
                media_content_type: dialog
                extra:
                  volume_level: 0.9
        # Bouth came home
        - conditions:
            - condition: state
              entity_id: person.sen
              state: "home"
            - condition: state
              entity_id: person.kris
              state: "home"
          sequence:
            - alias: "Switch on lights and welcome"
              choose:
                - conditions:
                    - condition: sun
                      after: sunset
                      before_offset: 00:15:00
                  sequence:
                    - service: switch.turn_on
                      entity_id: switch.string_lights
            - alias: "Welcome everybody"
              service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: >
                  Добро пожаловать домой мистер и миссис Морган
                media_content_type: dialog
                extra:
                  volume_level: 0.9

- id: "Home_All_Lights_OFF"
  alias: Home All Lights OFF
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_hall_door_sensor_contact
      from: "on"
      to: "off"
  condition:
    - condition: state
      entity_id: binary_sensor.tradfri_motion_sensor_occupancy
      state: "on"
    - condition: template
      value_template:
        "{{ ( as_timestamp(now()) - as_timestamp(state_attr('automation.welcome_home_mr_and_mrs',
        'last_triggered')) |int(0) ) > 60 }}"
    - condition: template
      value_template:
        "{{ ( as_timestamp(now()) - as_timestamp(state_attr('automation.welcome_hall_light',
        'last_triggered')) |int(0) ) > 60 }}"
  action:
    - wait_template: "{{ states('binary_sensor.people_home') == 'off' }}"
      timeout: "00:30:00"
      continue_on_timeout: false
    - service: light.turn_off
      entity_id: all
    - service: switch.turn_off
      entity_id: switch.string_lights
    - service: switch.turn_off
      entity_id: switch.bar_light
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Весь свет был погашен в {{ states('sensor.time') }}

- id: "Hall_Lights_by_Motion_ON"
  alias: Hall Lights by Motion ON
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_hall_door_sensor_contact
      to: "on"
    - platform: state
      entity_id: binary_sensor.aqara_hall_motion_sensor_occupancy
      to: "on"
  #  condition:
  #    - condition: time
  #      after: "6:00"
  #      before: "21:00"
  #    - condition: time
  #      weekday:
  #        - mon
  #        - tue
  #        - wed
  #        - thu
  #        - fri
  action:
    service: light.turn_on
    entity_id: light.hall_lights

- id: "Hall_Lights_by_Motion_OFF"
  alias: Hall Lights by Motion OFF
  trigger:
    platform: state
    entity_id: binary_sensor.aqara_hall_motion_sensor_occupancy
    to: "off"
  action:
    service: light.turn_off
    entity_id: light.hall_lights

###############################################
## Other Automatic Lights
###############################################

- id: "Kitchen_Spotlights_by_Motion_ON"
  alias: Kitchen Spotlights by Motion ON
  trigger:
    platform: state
    entity_id: binary_sensor.aqara_kitchen_workplace_motion_sensor_occupancy
    to: "on"
  condition:
    - condition: state
      entity_id: light.kitchen_spotlights
      state: "off"
    - condition: time
      after: "06:00"
      before: "21:00"
    - condition: numeric_state
      entity_id: sensor.aqara_kitchen_workplace_motion_sensor_illuminance_lux
      below: 10
  action:
    - service: light.turn_on
      entity_id: light.kitchen_spotlights
    - service: input_boolean.turn_on
      entity_id: input_boolean.flag_spotlight_triggered_by_motion

- id: "Kitchen_Spotlights_by_Motion_OFF"
  alias: Kitchen Spotlights by Motion OFF
  trigger:
    platform: state
    entity_id: binary_sensor.aqara_kitchen_workplace_motion_sensor_occupancy
    to: "off"
    for: 00:00:10
  condition:
    - condition: state
      entity_id: input_boolean.flag_spotlight_triggered_by_motion
      state: "on"
  action:
    - service: light.turn_off
      entity_id: light.kitchen_spotlights
    - service: input_boolean.turn_off
      entity_id: input_boolean.flag_spotlight_triggered_by_motion

- id: "Kitchen_Spotlights_Triggered_by_Motion_Flag_Unset"
  alias: Kitchen Spotlights Triggered by Motion Flag Unset
  trigger:
    platform: state
    entity_id: light.kitchen_spotlights
    to: "off"
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.flag_spotlight_triggered_by_motion

- id: "Kitchen_Motion_Sensor_Reset_State"
  alias: Kitchen Motion Sensor Reset State
  trigger:
    platform: state
    entity_id: binary_sensor.aqara_kitchen_workplace_motion_sensor_occupancy
    to: "on"
    for: 00:00:05
  action:
    - data_template:
        entity_id: binary_sensor.aqara_kitchen_workplace_motion_sensor_occupancy
        state: "off"
      service: python_script.set_state

- id: "Kitchen_Asus_PC_Background_Lights ON"
  alias: Kitchen Asus PC Background Lights ON
  trigger:
    - platform: sun
      id: "SUNSET"
      event: sunset
      offset: -00:20:00
    - platform: state
      id: "PC_ON"
      entity_id: switch.asus_pc
      from: "off"
      to: "on"
  condition:
    - condition: state
      entity_id: person.sen
      state: "home"
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: trigger
              id: "SUNSET"
            - condition: state
              entity_id: switch.asus_pc
              state: "on"
        - condition: and
          conditions:
            - condition: trigger
              id: "PC_ON"
            - condition: sun
              after: sunset
              before_offset: 00:20:00
  action:
    - service: light.turn_on
      entity_id:
        - light.gyver_lamp
    - service: switch.turn_on
      entity_id:
        - switch.tradrfri_outlet_1
    - choose:
        - conditions:
            - condition: state
              entity_id: person.kris
              state: "not_home"
          sequence:
            - service: light.turn_on
              entity_id:
                - light.shelf_lighting
            - service: switch.turn_on
              entity_id:
                - switch.pc_backlight_sync_send

- id: "Living_Room_Bar_Lights_by_Sunset_or_TV_ON"
  alias: Living Room Bar Lights by Sunset or TV ON
  trigger:
    - platform: sun
      id: "SUNSET"
      event: sunset
      offset: -00:15:00
    - platform: state
      id: "TV_ON"
      entity_id: media_player.tv
      to: "on"
  condition:
    - condition: state
      entity_id: person.sen
      state: "home"
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: trigger
              id: "SUNSET"
            - condition: state
              entity_id: media_player.tv
              state: "on"
        - condition: and
          conditions:
            - condition: trigger
              id: "TV_ON"
            - condition: sun
              after: sunset
              before_offset: 00:15:00
  action:
    - wait_template: "{{ states('switch.asus_pc') == 'off' }}"
      timeout: 00:10:00
      continue_on_timeout: false
    - wait_template: "{{ states('light.kitchen_spotlights') == 'off' }}"
      timeout: 00:10:00
      continue_on_timeout: false
    - service: scene.turn_on
      entity_id: scene.movies

- id: "Living_Room_Bar_Lights_by_Sunrise_OFF"
  alias: Living Room Bar Lights by Sunrise OFF
  trigger:
    - platform: sun
      event: sunrise
      offset: -01:00:00
  action:
    - service: light.turn_off
      entity_id: switch.bar_light

###############################################
## Cover Automations
###############################################

- id: "Bedroom_Blinds_by_Sunset_Close"
  alias: Bedroom Blinds by Sunset Close
  trigger:
    - platform: sun
      event: sunset
      offset: 00:20:00
  condition:
    - condition: state
      entity_id: cover.bedroom
      state: open
    - condition: state
      entity_id: binary_sensor.aqara_bedroom_window_sensor_contact
      state: "off"
  action:
    - service: cover.close_cover
      entity_id: cover.bedroom

###############################################
## Alarms
###############################################

- id: "Alarm_Morgan"
  alias: Alarm Morgan
  trigger:
    - platform: time_pattern
      minutes: /1
      seconds: 0
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: template
      value_template:
        '{{ now().strftime("%H:%M") == states.sensor.alarm_1_time.state
        }}'
    - condition: state
      entity_id: cover.bedroom
      state: closed
    - condition: state
      entity_id: person.sen
      state: "home"
  action:
    - service: cover.open_cover
      entity_id: cover.bedroom
    - service: switch.turn_on
      entity_id: switch.asus_pc

- id: "Alarm_Kris"
  alias: Alarm Kris
  trigger:
    - platform: time_pattern
      minutes: /1
      seconds: 0
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: template
      value_template:
        '{{ now().strftime("%H:%M") == states.sensor.alarm_2_time.state
        }}'
    - condition: state
      entity_id: cover.bedroom
      state: closed
  action:
    - service: light.turn_on
      data:
        entity_id: light.floor_lamp
        brightness: 50

- id: "Alarm_Weekends"
  alias: Alarm Weekends
  trigger:
    - platform: time_pattern
      minutes: /1
      seconds: 0
  condition:
    - condition: time
      weekday:
        - sat
        - sun
    - condition: template
      value_template:
        '{{ now().strftime("%H:%M") == states.sensor.alarm_3_time.state
        }}'
    - condition: state
      entity_id: cover.bedroom
      state: closed
  action:
    - service: cover.open_cover
      entity_id: cover.bedroom

- id: "Alarm_Weekdays"
  alias: Alarm Weekdays
  trigger:
    - platform: time_pattern
      minutes: /1
      seconds: 0
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: template
      value_template:
        '{{ now().strftime("%H:%M") == states.sensor.alarm_4_time.state
        }}'
    - condition: state
      entity_id: cover.bedroom
      state: closed
  action:
    - service: cover.open_cover
      entity_id: cover.bedroom

###############################################
## Notifications
###############################################

- id: "Notification_Kris_Arrived"
  alias: Notification Kris Arrived
  trigger:
    - platform: state
      entity_id: person.kris
      to: "home"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Кристина пришла домой в {{ states('sensor.time') }}

- id: "Notification_Kris_Leaved"
  alias: Notification Kris Leaved
  trigger:
    - platform: state
      entity_id: person.kris
      from: "home"
      to: "not_home"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Кристина ушла в {{ states('sensor.time') }}

- id: "Notification_Snow"
  alias: Notification Snow
  trigger:
    - platform: numeric_state
      entity_id: sensor.openweathermap_snow
      above: 0
  action:
    - service: notify.mobile_app_sm_a515f
      data_template:
        title: Уведомление о снеге {{ '\u2744\ufe0f' }}
        message: Должно выпасть {{ states('sensor.openweathermap_snow') }} мм снега

- id: "Notification_Every_100_Duco_Mined"
  alias: Notification Every 100 Duco Mined
  trigger:
    - platform: state
      entity_id: sensor.duco_balance_100_trigger
  condition:
    - condition: template
      value_template: >-
        {% if states.sensor.duco_balance %}
        true
        {% else %}
        false
        {% endif %}
    - condition: template
      value_template: >-
        {{ not is_state(trigger.from_state.state, "unavailable") and
        not is_state(trigger.from_state.state, "unknown") and
        not is_state(trigger.to_state.state, "unavailable") and
        not is_state(trigger.to_state.state, "unknown") }}
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: "{{ '\u26cf\ufe0f' }} You have mined {{ states('sensor.duco_balance') | round(0) }} DUCO {{ '\ud83e\ude99' }}"

###############################################
## Raven Notifications
###############################################

- id: "Notification_Raven_Connected"
  alias: Notification Raven Connected
  trigger:
    - platform: state
      entity_id: person.raven
      to: "home"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Сообщение от Raven"
        message: Raven подключился к серверу

- id: "Notification_Raven_Disconnected"
  alias: Notification Raven Disconnected
  trigger:
    - platform: state
      entity_id: person.raven
      to: "not_home"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Сообщение от Raven"
        message: Raven отключился от сервера

- id: "Notification_Raven_Alarm"
  alias: Notification Raven Alarm
  trigger:
    - platform: state
      entity_id: binary_sensor.raven_alarm
      from: "off"
      to: "on"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ '❗️' }} Сообщение от Raven"
        message: Несанкционированный доступ в Raven в {{ states('sensor.time') }}

- id: "Notification_Raven_Low_Battery"
  alias: Notification Raven Low Battery
  trigger:
    - platform: numeric_state
      entity_id: sensor.raven_battery_voltage
      below: 12.2
      for: "00:00:30"
  action:
    - alias: "Set up variables for the actions"
      variables:
        # Including an id in the action allows us to identify this script run
        # and not accidentally trigger for other notification actions
        action_start_charging: "{{ 'START_CHARGING_' ~ context.id }}"
    - alias: "Ask to ask to start charging"
      service: notify.mobile_app_sm_a515f
      data:
        title: "{{ '❗️' }} Сообщение от Raven"
        message: Низкое бортовое напряжение - {{ states('sensor.raven_battery_voltage') }}V
        data:
          actions:
            - action: "{{ action_start_charging }}"
              title: "Start Charging"
            - action: "URI"
              title: "Open URI"
              uri: "/lovelace/raven"
    - alias: "Wait for a response"
      wait_for_trigger:
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            # waiting for the specific action avoids accidentally continuing
            # for another script/automation's notification action
            action: "{{ action_start_charging }}"
    - alias: "Perform the action"
      choose:
        - conditions: "{{ wait.trigger.event.data.action == action_start_charging }}"
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.backyard_socket

###############################################
## Home Assistant Notifications
###############################################

- id: "Notification_Home_Assistant_Started"
  alias: Notification Home Assistant Started
  trigger:
    - platform: homeassistant
      event: start
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: "Cервер запущен {{ '\uD83D\uDC4C' }} в {{ states('sensor.time') }}."

- id: "Notification_Home_Assistant_Stopped"
  alias: Notification Home Assistant Stopped
  trigger:
    - platform: event
      event_type: homeassistant_stop
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: "Сервер остановлен {{'\uD83D\uDED1'}} в {{ states('sensor.time') }}"

- id: "Notification_New_Device_Connected"
  alias: Notification New Device Connected
  mode: queued
  trigger:
    platform: event
    event_type: entity_registry_updated
    event_data:
      action: create
  condition: >
    {{trigger.event.data.entity_id.startswith('device_tracker')}}
  action:
    - variables:
        entity: >
          {{trigger.event.data.entity_id}}
    - service: system_log.write
      data:
        message: >
          New device registrered: {{state_attr(entity,'friendly_name')}}
        level: warning
        logger: homeassistant.components.device_tracker
    - service: persistent_notification.create
      data:
        title: >
          New device registered: {{state_attr(entity,'friendly_name')}}
        message: >
          Entity: {{entity}}
          Host: {{state_attr(entity,'host_name')}}
          Ip: {{state_attr(entity,'ip')}}
          Mac-address: {{state_attr(entity,'mac')}}
          Full data: {{trigger.event.data}}
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: "В сети появилось {{ '\uD83D\uDCE1' }} новое устройство {{state_attr(entity,'friendly_name')}}"
    - service: media_player.play_media
      entity_id: media_player.yandex_station
      data:
        media_content_id: >
          К локальной сети было подключено новое устройство с именем {{state_attr(entity,'friendly_name')}}
        media_content_type: dialog
        extra:
          volume_level: 0.8

- id: "Notification_Home_Assistant_Update_Available"
  alias: Notification Home Assistant Update Available
  trigger:
    - platform: state
      entity_id: binary_sensor.home_assistant_versions_update_available
      from: "off"
      to: "on"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: "Update! {{ '\uD83C\uDF0D' }} Доступна новая версия {{ states('sensor.home_assistant_versions') }}"
        data:
          actions:
            - action: "URI"
              title: "Open Config"
              uri: "/config"

- id: "Notification_ISS_is_overhead"
  alias: Notification ISS is overhead
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.home_assistant_versions_update_available
      from: "off"
      to: "on"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: 🛰 МКС над головой! 🛰
        message: МКС поднялась выше 10° над горизонтом в {{ states('sensor.time') }}

###############################################
## Home Assistant Automations
###############################################

- id: letsencrypt-renewal
  initial_state: true
  alias: Let's Encrypt Renewal
  trigger:
    - platform: time
      at: 00:00:00
  action:
    - service: hassio.addon_restart
      data:
        addon: core_letsencrypt

###############################################
## Aqara Cube Automations
###############################################

- id: "Aqara_Cube_Flip_90"
  alias: Aqara Cube Flip 90
  trigger:
    platform: state
    entity_id: sensor.aqara_cube_1_action
    to: "flip90"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.toggle
      entity_id: light.kitchen_spotlights

- id: "Aqara_Cube_Flip_180"
  alias: Aqara Cube Flip 180
  trigger:
    platform: state
    entity_id: sensor.aqara_cube_1_action
    to: "flip180"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.turn_off
      entity_id: all

- id: "Aqara_Cube_Shake"
  alias: Aqara Cube Shake
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "shake"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: media_player.play_media
      entity_id: media_player.yandex_station
      data:
        media_content_id: О да, встряхни меня, детка!
        media_content_type: dialog
        extra:
          volume_level: 0.8
    - service: light.toggle
      entity_id:
        - light.kitchen_spotlights
        - light.floor_lamp
    - delay: 0.8
    - service: light.toggle
      entity_id:
        - light.kitchen_spotlights
        - light.floor_lamp
    - delay: 0.8
    - service: light.toggle
      entity_id:
        - light.kitchen_spotlights
        - light.floor_lamp
    - delay: 0.8
    - service: light.toggle
      entity_id:
        - light.kitchen_spotlights
        - light.floor_lamp
    - delay: 0.8

- id: "Aqara_Cube_Tap"
  alias: Aqara Cube Tap
  trigger:
    platform: state
    entity_id: sensor.aqara_cube_1_action
    to: "tap"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: scene.turn_on
      entity_id: scene.movies

- id: "Aqara_Cube_Slide"
  alias: Aqara Cube Slide
  trigger:
    platform: state
    entity_id: sensor.aqara_cube_1_action
    to: "slide"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.toggle
      entity_id: light.mi_desk_lamp

- id: "Aqara_Cube_Rotate"
  alias: Aqara Cube Rotate
  trigger:
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "rotate_left"
    - platform: state
      entity_id: sensor.aqara_cube_1_action
      to: "rotate_right"
  condition:
    - condition: state
      entity_id: input_boolean.cube_1_control
      state: "on"
  action:
    - service: light.turn_on
      entity_id: light.mi_desk_lamp
      data_template:
        brightness:
          "{% set suggested = states.light.mi_desk_lamp.attributes.brightness\
          \ | int + \n  states.sensor.aqara_cube_1_action.attributes.angle | int + 1\
          \ %}\n{% if suggested > 0 %} {{ suggested }} {% else %} 1 {% endif %}\n"

###############################################
## Aqara Switch Automations
###############################################

- id: "Bedroom_Aqara_Switch_Single_Press"
  alias: Bedroom Aqara Switch Single Press
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "single"
  action:
    - service: light.turn_off
      entity_id: all
    - service: scene.turn_on
      entity_id: scene.good_night

- id: "Bedroom_Aqara_Switch_Triple_Press"
  alias: Bedroom Aqara Switch Triple Press
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "triple"
  action:
    - service: switch.turn_off
      entity_id: switch.asus_pc

- id: "Bedroom_Aqara_Switch_Hold"
  alias: Bedroom Aqara Switch Hold
  trigger:
    platform: state
    entity_id: sensor.aqara_switch_1_action
    to: "hold"
  action:
    - service: cover.open_cover
      entity_id: cover.bedroom

###############################################
## Floorlamp Tradfri Switch Control
###############################################

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_ON"
  alias: Living Room Floorlamp Tradfri Switch Control ON
  trigger:
    platform: state
    entity_id: sensor.tradfri_switch_action
    to: "on"
  action:
    - service: light.turn_on
      entity_id: light.floor_lamp

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_OFF"
  alias: Living Room Floorlamp Tradfri Switch Control OFF
  trigger:
    platform: state
    entity_id: sensor.tradfri_switch_action
    to: "off"
  action:
    - service: light.turn_off
      entity_id: light.floor_lamp

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_Brightness_Up"
  alias: Floorlamp Tradfri Switch Control Brightness Up
  trigger:
    - platform: state
      entity_id: sensor.tradfri_switch_action
      to: "brightness_move_up"
  condition:
    - condition: state
      entity_id: light.floor_lamp
      state: "on"
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.light_brightness
    - service: python_script.change_attribute_light_smoothly
      data:
        light_id: light.floor_lamp
        input_boolean: input_boolean.light_brightness
        delta: 10

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_Brightness_Down"
  alias: Living Room Floorlamp Tradfri Switch Control Brightness Down
  trigger:
    - platform: state
      entity_id: sensor.tradfri_switch_action
      to: "brightness_move_down"
  condition:
    - condition: state
      entity_id: light.floor_lamp
      state: "on"
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.light_brightness
    - service: python_script.change_attribute_light_smoothly
      data:
        light_id: light.floor_lamp
        input_boolean: input_boolean.light_brightness
        delta: -10

- id: "Living_Room_Floorlamp_Tradfri_Switch_Control_Brightness_Controll_OFF"
  alias: Living Room Floorlamp Tradfri Switch Control Brightness Controll OFF
  initial_state: "on"
  trigger:
    - platform: state
      entity_id: sensor.tradfri_switch_action
      to: brightness_stop
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.light_brightness
        state: "on"
      - condition: state
        entity_id: light.floor_lamp
        state: "on"
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.light_brightness

###############################################
## Thermostat automations
###############################################

- id: "Kitchen_Thermostat_Change_Mode_by_Window_State"
  alias: Kitchen Thermostat Change Mode by Window State
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.aqara_bedroom_window_sensor_contact
      id: Window Opened
      to: "on"
      from: "off"
      for: "00:00:05"
    - platform: state
      entity_id: binary_sensor.aqara_bedroom_window_sensor_contact
      id: Window Closed
      from: "on"
      to: "off"
      for: "00:00:05"
  condition:
    - condition: or
      conditions:
        - condition: and
          conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: climate.thermostat
                  state: auto
                - condition: state
                  entity_id: climate.thermostat
                  state: heat
            - condition: trigger
              id: Window Opened
        - condition: and
          conditions:
            - condition: state
              entity_id: climate.thermostat
              state: "off"
            - condition: trigger
              id: Window Closed
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: Window Opened
          sequence:
            - service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: Термостат отключен
                media_content_type: dialog
                extra:
                  volume_level: 0.8
            - service: climate.set_hvac_mode
              data:
                hvac_mode: "off"
              target:
                entity_id: climate.thermostat
        - conditions:
            - condition: trigger
              id: Window Closed
          sequence:
            - service: media_player.play_media
              entity_id: media_player.yandex_station
              data:
                media_content_id: Термостат будет включен снова через 30 минут
                media_content_type: dialog
                extra:
                  volume_level: 0.8
            - delay: 30:00
            # Need to send the command a few times to ensure that thermostat changed it's mode
            - repeat:
                until:
                  - condition: state
                    entity_id: climate.thermostat
                    state: auto
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: climate.thermostat
                    data:
                      hvac_mode: "auto"
                  - delay:
                      seconds: 5

- id: "Kitchen_Thermostat_Emergency_ON"
  alias: Kitchen Thermostat Emergency ON
  mode: single
  trigger:
    - platform: numeric_state
      entity_id: climate.thermostat
      attribute: current_temperature
      below: 20
    - platform: time
      at: "01:00"
  condition:
    - condition: numeric_state
      entity_id: climate.thermostat
      attribute: current_temperature
      below: 20
    - condition: state
      entity_id: binary_sensor.people_home
      state: "on"
    - condition: time
      after: "00:00"
      before: "06:00"
  action:
    - service: notify.mobile_app_sm_a515f
      data:
        title: "{{ 'ℹ️' }} Системное уведомление"
        message: Термостат был снова включен в {{ states('sensor.time') }}, чтобы вы не замёрзли
    # Need to send the command a few times to ensure that thermostat changed it's mode
    - repeat:
        until:
          - condition: state
            entity_id: climate.thermostat
            state: auto
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: climate.thermostat
            data:
              hvac_mode: "auto"
          - delay:
              seconds: 5

###############################################
## Media Players Control
###############################################

- id: "Living_Room_TV_by_WoL_ON"
  alias: Living Room TV by WoL ON
  mode: restart
  trigger:
    - platform: webostv.turn_on
      entity_id: media_player.tv
  action:
    - service: wake_on_lan.send_magic_packet
      data:
        mac: !secret TV_MAC

###############################################
## Other Buttons and Switches Handles
###############################################

- id: "Parking_Lights_ON"
  alias: Parking Lights ON
  trigger:
    - platform: state
      entity_id: input_button.parking_light
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.parking_light
    - delay:
        seconds: 15
    - repeat:
        while:
          - condition: state
            entity_id: switch.parking_light
            state: "off"
          # Don't do it too many times
          - condition: template
            value_template: "{{ repeat.index <= 10 }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: switch.parking_light
          - delay:
              seconds: 1

- id: "Kitchen_Presentation_ON"
  alias: Kitchen Presentation ON
  trigger:
    - platform: state
      entity_id: input_boolean.presentation_switch
      to: "on"
  condition:
    - condition: state
      entity_id: script.presentation
      state: "off"
  action:
    - service: script.turn_on
      target:
        entity_id: script.presentation
    - service: input_boolean.turn_off
      entity_id: input_boolean.presentation_switch
